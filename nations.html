<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›½å®¶ç©å®¶é¢æ¿æŠ½å–</title>
    <!-- å¼•å…¥Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- å¼•å…¥html2canvas -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <!-- é…ç½®Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563EB',
                        secondary: '#4B5563',
                        accent: '#F59E0B',
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s ease-in-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                },
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-hover {
                @apply transition-all duration-300 hover:shadow-xl hover:scale-[1.02];
            }
            .image-container {
                @apply relative overflow-hidden rounded-t-lg bg-gray-100;
                padding-top: 75%; /* 4:3 æ¯”ä¾‹ï¼ˆé«˜åº¦=å®½åº¦*0.75ï¼‰ */
            }
            .image-cover {
                @apply absolute inset-0 w-full h-full object-contain transition-all duration-700 opacity-0;
                background-color: #f3f4f6; /* å›¾ç‰‡æœªå¡«æ»¡åŒºåŸŸç”¨æµ…ç°èƒŒæ™¯è¿‡æ¸¡ */
            }
            .image-cover.loaded {
                @apply opacity-100;
            }
            .card-link:hover .image-cover {
                @apply scale-105; /* å‡å°ç¼©æ”¾å¹…åº¦ï¼Œé¿å…è¿‡åº¦è£å‰ª */
            }
            .btn-primary {
                @apply bg-primary hover:bg-primary/90 text-white font-medium py-3 px-6 rounded-lg transition-all duration-300 flex items-center justify-center gap-2 shadow-md hover:shadow-lg;
            }
            .btn-outline {
                @apply border border-gray-300 hover:border-primary text-gray-700 hover:text-primary font-medium py-2 px-4 rounded-lg transition-all duration-300;
            }
            .image-loader {
                @apply absolute inset-0 flex items-center justify-center bg-gray-100 z-10;
            }
            .share-btn {
                @apply text-sm text-gray-600 hover:text-primary transition-colors flex items-center gap-1;
            }
            .config-btn {
                @apply relative text-gray-600 hover:text-primary transition-colors p-2 rounded-full hover:bg-gray-100;
            }
            .config-badge {
                @apply absolute top-0 right-0 w-2 h-2 bg-accent rounded-full;
            }
            /* æ¨¡æ€æ¡†å›¾ç‰‡å®¹å™¨æ ·å¼ä¼˜åŒ– */
            .modal-image-container {
                @apply relative w-full max-h-[70vh] flex items-center justify-center bg-gray-100 rounded overflow-hidden;
            }
            .modal-image {
                @apply max-w-full max-h-full object-contain transition-opacity duration-500 ease-in-out;
            }
            /* ç‹æœå›¾ç‰‡ç¼©ç•¥å›¾æ ·å¼ */
            .dynasty-thumbnail {
                @apply w-16 h-12 object-cover rounded border cursor-pointer transition-all;
            }
            .dynasty-thumbnail.active {
                @apply border-primary ring-2 ring-primary/30;
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-gray-800 min-h-screen flex flex-col">
<!-- é¡µé¢å¤´éƒ¨ -->
<header class="bg-white shadow-sm sticky top-0 z-30">
    <div class="container mx-auto px-4 py-5">
        <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
            <h1 class="text-[clamp(1.5rem,3vw,2.2rem)] font-bold text-gray-900 flex items-center">
                <i class="fa fa-globe text-primary mr-3 text-2xl"></i>
                å›½å®¶ç©å®¶é¢æ¿æŠ½å–
            </h1>
            <div class="flex items-center gap-3">
                <span id="countryCount" class="text-sm text-secondary bg-gray-100 px-3 py-1.5 rounded-full">
                    å›½å®¶åº“: <span id="availableCountriesCount">17</span>ä¸ª
                </span>
                <!-- æ–°å¢ï¼šå›¾ç‰‡æ¥æºé…ç½®æŒ‰é’® -->
                <div class="relative" id="imageConfigWrapper">
                    <button id="imageConfigBtn" class="config-btn" aria-haspopup="true" aria-expanded="false">
                        <i class="fa fa-picture-o text-lg"></i>
                        <span class="config-badge"></span>
                    </button>
                    <!-- å›¾ç‰‡æ¥æºä¸‹æ‹‰èœå• - ä¿®æ”¹å®šä½å’ŒåŠ¨ç”» -->
                    <div id="imageConfigMenu" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-1 hidden z-40 transition-all duration-200 transform origin-top-right">
                        <label class="block px-4 py-2 text-sm text-gray-700 font-medium">å›¾ç‰‡æ¥æº</label>
                        <div class="px-2 py-1">
                            <label class="flex items-center px-2 py-2 rounded hover:bg-gray-100 cursor-pointer">
                                <input type="radio" name="imageSource" value="image" checked class="mr-2 text-primary">
                                <span>é»˜è®¤è¿œç¨‹å›¾ (image)</span>
                            </label>
                            <label class="flex items-center px-2 py-2 rounded hover:bg-gray-100 cursor-pointer">
                                <input type="radio" name="imageSource" value="localImg" class="mr-2 text-primary">
                                <span>æœ¬åœ°å›¾ (localImg)</span>
                            </label>
                        </div>
                    </div>
                </div>
                <button id="resetBtn" class="btn-outline text-sm">
                    <i class="fa fa-refresh mr-1"></i> é‡ç½®
                </button>
            </div>
        </div>
    </div>
</header>

<!-- ä¸»è¦å†…å®¹åŒº -->
<main class="flex-grow container mx-auto px-4 py-8">
    <!-- é€‰æ‹©åŒºåŸŸ -->
    <section class="bg-white rounded-xl shadow-md p-6 mb-8 max-w-3xl mx-auto animate-fade-in">
        <h2 class="text-xl font-semibold mb-4 flex items-center">
            <i class="fa fa-cog text-primary mr-2"></i> æŠ½å–è®¾ç½®
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- äººæ•°é€‰æ‹© -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©ç©å®¶äººæ•° (1-5äºº)</label>
                <div class="flex flex-wrap gap-2">
                    <button class="player-btn btn-outline active bg-primary text-white border-primary" data-count="1">1äºº</button>
                    <button class="player-btn btn-outline" data-count="2">2äºº</button>
                    <button class="player-btn btn-outline" data-count="3">3äºº</button>
                    <button class="player-btn btn-outline" data-count="4">4äºº</button>
                    <button class="player-btn btn-outline" data-count="5">5äºº</button>
                </div>
                <p id="playerTip" class="mt-2 text-sm text-gray-500">è¯·é€‰æ‹©éœ€è¦åˆ†é…å›½å®¶çš„ç©å®¶äººæ•°</p>
            </div>

            <!-- ç¦ç”¨å›½å®¶é€‰é¡¹ -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">æ’é™¤å›½å®¶</label>
                <div class="flex flex-wrap gap-2">
                    <label class="inline-flex items-center">
                        <input type="checkbox" id="disableKorea" class="rounded text-primary focus:ring-primary" checked>
                        <span class="ml-2">éŸ©å›½</span>
                    </label>
                </div>
                <p class="mt-2 text-sm text-gray-500">é€‰æ‹©è¦æ’é™¤çš„å›½å®¶</p>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="flex flex-col justify-end">
                <button id="drawBtn" class="btn-primary w-full">
                    <i class="fa fa-random"></i> å¼€å§‹éšæœºæŠ½å–
                </button>
                <p class="mt-2 text-xs text-gray-400 text-center">
                    æ¯æ¬¡æŠ½å–å°†ä»å¯ç”¨å›½å®¶ä¸­éšæœºé€‰æ‹©å¯¹åº”äººæ•°çš„ä¸åŒå›½å®¶
                </p>
            </div>
            <!-- æ·»åŠ æç¤ºä¿¡æ¯ -->
            <div class="flex flex-col justify-end">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm">
                    <p class="text-blue-800 flex items-start">
                        <i class="fa fa-info-circle mt-0.5 mr-2 flex-shrink-0"></i>
                        <span>å¦‚éœ€ç”Ÿæˆå›¾ç‰‡ç»“æœï¼Œéœ€ä½¿ç”¨æœ¬åœ°å›¾æº</span>
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
    <section id="resultSection" class="hidden">
        <div class="flex flex-wrap justify-between items-center mb-6 max-w-6xl mx-auto gap-4">
            <h2 class="text-xl font-semibold flex items-center">
                <i class="fa fa-trophy text-accent mr-2"></i> æŠ½å–ç»“æœ
                <span id="resultCount" class="ml-2 text-sm text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full"></span>
                <!-- æ–°å¢ï¼šæ˜¾ç¤ºå½“å‰å›¾ç‰‡æ¥æº -->
                <span id="currentImageSource" class="ml-2 text-sm text-gray-500 bg-blue-50 px-2 py-0.5 rounded-full hidden">
                    å›¾ç‰‡æ¥æº: <span class="font-medium">é»˜è®¤è¿œç¨‹å›¾</span>
                </span>
            </h2>
            <div class="flex gap-3">
                <button id="shareBtn" class="btn-outline">
                    <i class="fa fa-share-alt mr-1"></i> åˆ†äº«ç»“æœ
                </button>
                <button id="redrawBtn" class="btn-outline">
                    <i class="fa fa-refresh mr-1"></i> é‡æ–°æŠ½å–
                </button>
            </div>
        </div>

        <!-- å›½å®¶å¡ç‰‡å®¹å™¨ -->
        <div id="countryContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 max-w-6xl mx-auto">
            <!-- å›½å®¶å¡ç‰‡å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </section>

    <!-- åˆå§‹çŠ¶æ€æç¤º -->
    <section id="initialState" class="text-center py-16 max-w-2xl mx-auto animate-fade-in">
        <div class="bg-white rounded-xl shadow-sm p-8">
            <div class="w-20 h-20 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa fa-globe text-primary text-3xl"></i>
            </div>
            <h3 class="text-xl font-semibold mb-2">å‡†å¤‡å¼€å§‹æŠ½å–</h3>
            <p class="text-gray-500 mb-6">è¯·åœ¨ä¸Šæ–¹é€‰æ‹©ç©å®¶äººæ•°å¹¶ç‚¹å‡»"å¼€å§‹éšæœºæŠ½å–"æŒ‰é’®</p>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 max-w-md mx-auto">
                <div class="bg-gray-100 rounded-lg p-3 text-center text-sm">
                    <div class="font-medium" id="initialCountryCount">17</div>
                    <div class="text-xs text-gray-500">å¯é€‰å›½å®¶</div>
                </div>
                <div class="bg-gray-100 rounded-lg p-3 text-center text-sm">
                    <div class="font-medium">1-5</div>
                    <div class="text-xs text-gray-500">æ”¯æŒäººæ•°</div>
                </div>
                <div class="bg-gray-100 rounded-lg p-3 text-center text-sm">
                    <div class="font-medium">2ç§</div>
                    <div class="text-xs text-gray-500">å›¾ç‰‡æ¥æº</div>
                </div>
                <div class="bg-gray-100 rounded-lg p-3 text-center text-sm">
                    <div class="font-medium">å¯åˆ†äº«</div>
                    <div class="text-xs text-gray-500">ç»“æœé“¾æ¥</div>
                </div>
            </div>
        </div>
    </section>

    <!-- åŠ è½½çŠ¶æ€ -->
    <section id="loadingState" class="hidden text-center py-16 max-w-2xl mx-auto">
        <div class="bg-white rounded-xl shadow-sm p-8">
            <div class="w-20 h-20 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa fa-circle-o-notch fa-spin text-primary text-3xl"></i>
            </div>
            <h3 class="text-xl font-semibold mb-2">æ­£åœ¨æŠ½å–å›½å®¶é¢æ¿</h3>
            <p class="text-gray-500" id="loadingText">è¯·ç¨å€™...</p>
            <div class="mt-6 w-full bg-gray-200 rounded-full h-2.5">
                <div id="loadingBar" class="bg-primary h-2.5 rounded-full w-0 transition-all duration-1500"></div>
            </div>
        </div>
    </section>
</main>

<!-- åˆ†äº«æ¨¡æ€æ¡† -->
<div id="shareModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-xl max-w-md w-full p-6 animate-fade-in">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">åˆ†äº«ç»“æœ</h3>
            <button id="closeShareModal" class="text-gray-500 hover:text-gray-800">
                <i class="fa fa-times"></i>
            </button>
        </div>
        <p class="text-gray-600 mb-4">å¤åˆ¶ä¸‹é¢çš„é“¾æ¥ï¼Œåˆ†äº«ç»™ä»–äººæŸ¥çœ‹ç›¸åŒçš„æŠ½å–ç»“æœï¼š</p>
        <div class="flex gap-2 mb-4">
            <input type="text" id="shareUrl" class="flex-grow px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" readonly>
            <button id="copyUrlBtn" class="btn-outline whitespace-nowrap">
                <i class="fa fa-copy mr-1"></i> å¤åˆ¶
            </button>
        </div>
        <!-- æ·»åŠ ç”Ÿæˆå›¾ç‰‡æŒ‰é’® -->
        <div class="mt-4 pt-4 border-t border-gray-200">
            <button id="generateImageBtn" class="w-full btn-primary">
                <i class="fa fa-image mr-2"></i> ç”Ÿæˆç»“æœå›¾ç‰‡
            </button>
            <p class="mt-2 text-xs text-gray-500 text-center">
                ç”ŸæˆåŒ…å«æ‰€æœ‰å›½å®¶ä¿¡æ¯çš„å›¾ç‰‡ï¼Œå¯é•¿æŒ‰ä¿å­˜
            </p>
        </div>
    </div>
</div>

<!-- å›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡†ï¼ˆé¢„å…ˆåˆ›å»ºï¼Œé¿å…åŠ¨æ€åˆ›å»ºçš„DOMé—®é¢˜ï¼‰ -->
<div id="imageModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] flex flex-col animate-fade-in">
        <div class="p-4 border-b flex justify-between items-center">
            <h3 class="font-semibold text-lg flex items-center" id="modalTitle">
                å›¾ç‰‡æŸ¥çœ‹
            </h3>
            <button id="closeImageModal" class="text-gray-500 hover:text-gray-800 transition-colors">
                <i class="fa fa-times text-xl"></i>
            </button>
        </div>
        <div class="flex-grow p-4">
            <div class="modal-image-container">
                <!-- å›¾ç‰‡åŠ è½½æŒ‡ç¤ºå™¨ -->
                <div class="image-loader" id="modalImageLoader">
                    <i class="fa fa-circle-o-notch fa-spin text-primary/50 text-2xl"></i>
                </div>
                <!-- å›¾ç‰‡å…ƒç´  -->
                <img id="modalImage" class="modal-image opacity-0" alt="å›½å®¶é¢æ¿è¯¦æƒ…å›¾">
            </div>
            <!-- ç¼©ç•¥å›¾å¯¼èˆªåŒºåŸŸ -->
            <div id="thumbnailNavigation" class="mt-4 flex flex-wrap justify-center gap-2"></div>
            <!-- é”™è¯¯æç¤º -->
            <div id="modalImageError" class="mt-4 text-center text-amber-500 hidden">
                <i class="fa fa-exclamation-triangle mr-1"></i>
                <span>å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå·²è‡ªåŠ¨å°è¯•å¤‡ç”¨å›¾ç‰‡</span>
            </div>
        </div>
    </div>
</div>

<!-- å›¾ç‰‡ç”Ÿæˆå™¨å®¹å™¨ -->
<div id="imageGenerator" class="fixed -top-full -left-full bg-white p-6 rounded-xl shadow-lg" style="width: 600px; max-width: 90vw;">
    <div class="text-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800">éšæœºå›½å®¶æŠ½å–ç»“æœ</h2>
        <p class="text-gray-600">ç©å®¶æ•°é‡: <span id="genPlayerCount">0</span></p>
    </div>

    <div id="generatedCountries" class="space-y-6">
        <!-- å›½å®¶ä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
    </div>

    <div class="mt-6 text-center text-sm text-gray-500">
        <p>é•¿æŒ‰æˆ–å³é”®ç‚¹å‡»å›¾ç‰‡å¯ä¿å­˜åˆ°è®¾å¤‡</p>
        <p class="mt-1">Â© 2025 éšæœºå›½å®¶å›¾ç‰‡æŠ½å–å·¥å…·</p>
    </div>
</div>

<!-- é¡µè„š -->
<footer class="bg-gray-900 text-gray-300 mt-12">
</footer>

<!-- JavaScript -->
<script>
    // 17ä¸ªå›½å®¶çš„æ•°æ® - åŒ…å«å›½å®¶åç§°å’Œå°é¢å›¾
    const countryDatabase = [
        {
            name: "ä¸­å›½",
            image: "https://oss.gstonegames.com/static/image/discuss/f_1101359571_47874564.jpg",
            flag: "ğŸ‡¨ğŸ‡³",
            id: 0,
            localImg: "doc/nations/DPlayerBoard_China.jpg",
            dynasties: ["doc/nations/China_1.jpg", "doc/nations/China_2.jpg"]
        },
        {
            name: "ç¾å›½",
            image: "https://oss.gstonegames.com/static/image/discuss/f_6890359571_34162464.jpg",
            flag: "ğŸ‡ºğŸ‡¸",
            id: 1,
            localImg: "doc/nations/DPlayerBoard_America.jpg",
            dynasties: ["doc/nations/America_1.jpg", "doc/nations/America_2.jpg"]
        },
        {
            name: "åŸƒå¡ä¿„æ¯”äºš",
            image: "https://oss.gstonegames.com/static/image/discuss/f_9201359571_83136983.jpg",
            flag: "ğŸ‡ªğŸ‡¹",
            id: 2,
            localImg: "doc/nations/DPlayerBoard_Ethiopia.jpg",
            dynasties: ["doc/nations/Ethiopia_1.jpg", "doc/nations/Ethiopia_2.jpg"]
        },
        {
            name: "å°åº¦",
            image: "https://oss.gstonegames.com/static/image/discuss/f_9401359571_38747658.jpg",
            flag: "ğŸ‡®ğŸ‡³",
            id: 3,
            localImg: "doc/nations/DPlayerBoard_India.jpg",
            dynasties: ["doc/nations/India_1.jpg", "doc/nations/India_2.jpg"]
        },
        {
            name: "æ—¥æœ¬",
            image: "https://oss.gstonegames.com/static/image/discuss/f_8501359571_63655516.jpg",
            flag: "ğŸ‡¯ğŸ‡µ",
            id: 4,
            localImg: "doc/nations/DPlayerBoard_Japan.jpg",
            dynasties: ["doc/nations/Japan_1.jpg", "doc/nations/Japan_2.jpg"]
        },
        {
            name: "éŸ©å›½",
            image: "https://oss.gstonegames.com/static/image/discuss/f_8801359571_67030899.jpg",
            flag: "ğŸ‡°ğŸ‡·",
            id: 5,
            localImg: "doc/nations/DPlayerBoard_Korea.jpg",
            dynasties: ["doc/nations/Korea_1.jpg", "doc/nations/Korea_2.jpg"]
        },
        {
            name: "é©¬é‡Œ",
            image: "https://oss.gstonegames.com/static/image/discuss/f_9931359571_81956111.jpg",
            flag: "ğŸ‡²ğŸ‡±",
            id: 6,
            localImg: "doc/nations/DPlayerBoard_Mali.jpg",
            dynasties: ["doc/nations/Mali_1.jpg", "doc/nations/Mali_2.jpg"]
        },
        {
            name: "è’™å¤å›½",
            image: "https://oss.gstonegames.com/static/image/discuss/f_8041359571_75834469.jpg",
            flag: "ğŸ‡²ğŸ‡³",
            id: 7,
            localImg: "doc/nations/DPlayerBoard_Mongolia.jpg",
            dynasties: ["doc/nations/Mongolia_1.jpg", "doc/nations/Mongolia_2.jpg"]
        },
        {
            name: "æ³¢å…°",
            image: "https://oss.gstonegames.com/static/image/discuss/f_2241359571_40056557.jpg",
            flag: "ğŸ‡µğŸ‡±",
            id: 8,
            localImg: "doc/nations/DPlayerBoard_Poland.jpg",
            dynasties: ["doc/nations/Poland_1.jpg", "doc/nations/Poland_2.jpg"]
        },
        {
            name: "è‘¡è„ç‰™",
            image: "https://oss.gstonegames.com/static/image/discuss/f_1341359571_68162785.jpg",
            flag: "ğŸ‡µğŸ‡¹",
            id: 9,
            localImg: "doc/nations/DPlayerBoard_Portugal.jpg",
            dynasties: ["doc/nations/Portugal_1.jpg", "doc/nations/Portugal_2.jpg"]
        },
        {
            name: "ç½—é©¬",
            image: "https://oss.gstonegames.com/static/image/discuss/f_9341359571_30550665.jpg",
            flag: "ğŸ‡®ğŸ‡¹",
            id: 10,
            localImg: "doc/nations/DPlayerBoard_Rome.jpg",
            dynasties: ["doc/nations/Rome_1.jpg", "doc/nations/Rome_2.jpg"]
        },
        {
            name: "ç»´äº¬",
            image: "https://oss.gstonegames.com/static/image/discuss/f_2541359571_22370662.jpg",
            flag: "ğŸ‡³ğŸ‡´",
            id: 11,
            localImg: "doc/nations/DPlayerBoard_Vikings.jpg",
            dynasties: ["doc/nations/Vikings_1.jpg", "doc/nations/Vikings_2.jpg"]
        },
        {
            name: "æ³¢æ–¯",
            image: "https://oss.gstonegames.com/static/image/discuss/f_4141359571_85777670.jpg",
            flag: "ğŸ‡®ğŸ‡·",
            id: 12,
            localImg: "doc/nations/DPlayerBoard_Persia.jpg",
            dynasties: ["doc/nations/Persia_1.jpg", "doc/nations/Persia_2.jpg"]
        },
        {
            name: "åŸƒåŠ",
            image: "https://oss.gstonegames.com/static/image/discuss/f_9101359571_19497951.jpg",
            flag: "ğŸ‡ªğŸ‡¬",
            id: 13,
            localImg: "doc/nations/DPlayerBoard_Egypt.jpg",
            dynasties: ["doc/nations/Egypt_1.jpg", "doc/nations/Egypt_2.jpg"]
        },
        {
            name: "å¨å°¼æ–¯",
            image: "https://oss.gstonegames.com/static/image/discuss/f_6441359571_79701632.jpg",
            flag: "ğŸ‡®ğŸ‡¹",
            id: 14,
            localImg: "doc/nations/DPlayerBoard_Venice.jpg",
            dynasties: ["doc/nations/Venice_1.jpg", "doc/nations/Venice_2.jpg"]
        },
        {
            name: "é˜¿æ‹‰ä¼¯",
            image: "https://oss.gstonegames.com/static/image/discuss/f_1001359571_38305684.jpg",
            flag: "ğŸ‡¦ğŸ‡ª",
            id: 15,
            localImg: "doc/nations/DPlayerBoard_Arabs.jpg",
            dynasties: ["doc/nations/Arabs_1.jpg", "doc/nations/Arabs_2.jpg"]
        },
        {
            name: "å¸Œè…Š",
            image: "https://oss.gstonegames.com/static/image/discuss/f_9301359571_46725018.jpg",
            flag: "ğŸ‡¬ğŸ‡·",
            id: 16,
            localImg: "doc/nations/DPlayerBoard_Greece.jpg",
            dynasties: ["doc/nations/Greece_1.jpg", "doc/nations/Greece_2.jpg"]
        }
    ];

    // DOMå…ƒç´ 
    const playerBtns = document.querySelectorAll('.player-btn');
    const drawBtn = document.getElementById('drawBtn');
    const redrawBtn = document.getElementById('redrawBtn');
    const resetBtn = document.getElementById('resetBtn');
    const resultSection = document.getElementById('resultSection');
    const initialState = document.getElementById('initialState');
    const loadingState = document.getElementById('loadingState');
    const countryContainer = document.getElementById('countryContainer');
    const resultCount = document.getElementById('resultCount');
    const playerTip = document.getElementById('playerTip');
    const loadingText = document.getElementById('loadingText');
    const loadingBar = document.getElementById('loadingBar');
    const shareBtn = document.getElementById('shareBtn');
    const shareModal = document.getElementById('shareModal');
    const closeShareModal = document.getElementById('closeShareModal');
    const shareUrl = document.getElementById('shareUrl');
    const copyUrlBtn = document.getElementById('copyUrlBtn');
    const shareWechatBtn = document.getElementById('shareWechatBtn');
    // æ–°å¢ï¼šå›¾ç‰‡é…ç½®ç›¸å…³å…ƒç´ 
    const imageConfigBtn = document.getElementById('imageConfigBtn');
    const imageConfigMenu = document.getElementById('imageConfigMenu');
    const imageConfigWrapper = document.getElementById('imageConfigWrapper');
    const imageSourceRadios = document.querySelectorAll('input[name="imageSource"]');
    const currentImageSource = document.getElementById('currentImageSource');
    const currentImageSourceText = currentImageSource.querySelector('span.font-medium');
    // å›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡†å…ƒç´ ï¼ˆæ–°å¢ï¼‰
    const imageModal = document.getElementById('imageModal');
    const closeImageModal = document.getElementById('closeImageModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalImage = document.getElementById('modalImage');
    const modalImageLoader = document.getElementById('modalImageLoader');
    const modalImageError = document.getElementById('modalImageError');
    const thumbnailNavigation = document.getElementById('thumbnailNavigation');
    // å›¾ç‰‡ç”Ÿæˆç›¸å…³å…ƒç´ 
    const generateImageBtn = document.getElementById('generateImageBtn');
    const imageGenerator = document.getElementById('imageGenerator');
    const genPlayerCount = document.getElementById('genPlayerCount');
    const generatedCountries = document.getElementById('generatedCountries');
    // æ–°å¢ï¼šç¦ç”¨å›½å®¶ç›¸å…³å…ƒç´ 
    const disableKorea = document.getElementById('disableKorea');
    const countryCount = document.getElementById('countryCount');
    const availableCountriesCount = document.getElementById('availableCountriesCount');
    const initialCountryCount = document.getElementById('initialCountryCount');

    // çŠ¶æ€å˜é‡
    let selectedPlayerCount = 1;
    let drawnCountries = [];
    let currentSeed = null; // ç”¨äºç”Ÿæˆéšæœºæ•°çš„ç§å­
    let currentImageSourceType = 'localImg'; // é»˜è®¤ä¸ºimageï¼Œå¯åˆ‡æ¢ä¸ºlocalImg
    let currentModalCountry = null; // å½“å‰æ¨¡æ€æ¡†æ˜¾ç¤ºçš„å›½å®¶
    let disabledCountries = null; // é»˜è®¤ç¦ç”¨éŸ©å›½ (id: 5)


    // åˆå§‹åŒ–é¡µé¢
    document.addEventListener('DOMContentLoaded', () => {
        // è§£æURLå‚æ•°
        const params = new URLSearchParams(window.location.search);
        const countriesParam = params.get('countries');
        const countParam = params.get('count');
        const seedParam = params.get('seed');
        const imageSourceParam = params.get('imageSource'); // æ–°å¢ï¼šå›¾ç‰‡æ¥æºå‚æ•°
        const disabledParam = params.get('disabled'); // æ–°å¢ï¼šç¦ç”¨å›½å®¶å‚æ•°

        // åˆå§‹åŒ–ç¦ç”¨å›½å®¶
        if (disabledParam !== null) {
            // å½“æ˜ç¡®ä¼ é€’äº†disabledå‚æ•°æ—¶ï¼ˆå³ä½¿æ˜¯ç©ºå­—ç¬¦ä¸²ï¼‰
            if (disabledParam === '') {
                // å‚æ•°ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºä¸ç¦ç”¨ä»»ä½•å›½å®¶
                disabledCountries = new Set();
                disableKorea.checked = false;
            } else {
                // å‚æ•°åŒ…å«å…·ä½“å€¼ï¼ŒæŒ‰åŸé€»è¾‘å¤„ç†
                try {
                    disabledCountries = new Set(disabledParam.split(',').map(Number));
                    disableKorea.checked = disabledCountries.has(5);
                } catch (e) {
                    console.error('è§£æç¦ç”¨å›½å®¶å‚æ•°å¤±è´¥:', e);
                    disabledCountries = new Set([5]);
                    disableKorea.checked = true;
                }
            }
        } else {
            // æœªä¼ é€’disabledå‚æ•°ï¼Œä½¿ç”¨é»˜è®¤å€¼ï¼ˆç¦ç”¨éŸ©å›½ï¼‰
            disabledCountries = new Set([5]);
            disableKorea.checked = true;
        }

        updateAvailableCountriesCount();

        // åˆå§‹åŒ–å›¾ç‰‡æ¥æºï¼ˆä¼˜å…ˆä»URLå‚æ•°è·å–ï¼Œå¦åˆ™ç”¨é»˜è®¤å€¼ï¼‰
        if (imageSourceParam && ['image', 'localImg'].includes(imageSourceParam)) {
            currentImageSourceType = imageSourceParam;
            // æ›´æ–°å•é€‰æŒ‰é’®çŠ¶æ€
            imageSourceRadios.forEach(radio => {
                radio.checked = radio.value === currentImageSourceType;
            });
        }
        updateImageSourceDisplay(); // æ›´æ–°å›¾ç‰‡æ¥æºæ˜¾ç¤º

        // å¦‚æœæœ‰æœ‰æ•ˆçš„å‚æ•°ï¼Œç›´æ¥åŠ è½½ç»“æœ
        if (countriesParam && countParam && seedParam) {
            try {
                // è§£æå‚æ•°
                const countryIds = countriesParam.split(',').map(Number);
                const playerCount = parseInt(countParam);

                // éªŒè¯å‚æ•°æœ‰æ•ˆæ€§
                if (countryIds.length === playerCount && playerCount >= 1 && playerCount <= 5) {
                    // æ ¹æ®IDè·å–å›½å®¶æ•°æ®
                    drawnCountries = countryIds.map(id => {
                        const country = countryDatabase.find(c => c.id === id);
                        if (!country) throw new Error('æ— æ•ˆçš„å›½å®¶ID');
                        return country;
                    });

                    // è®¾ç½®é€‰ä¸­çš„ç©å®¶æ•°é‡
                    selectedPlayerCount = playerCount;
                    playerBtns.forEach(btn => {
                        if (parseInt(btn.dataset.count) === selectedPlayerCount) {
                            btn.click(); // è§¦å‘ç‚¹å‡»äº‹ä»¶ä»¥æ›´æ–°UI
                        }
                    });

                    // æ˜¾ç¤ºç»“æœ
                    currentSeed = seedParam;
                    initialState.classList.add('hidden');
                    bindImageModalEvents();
                    generateDrawResult(false); // ä¸æ˜¾ç¤ºåŠ è½½çŠ¶æ€ç›´æ¥ç”Ÿæˆç»“æœ
                    // ç»‘å®šå›¾ç‰‡æ¥æºåˆ‡æ¢äº‹ä»¶
                    bindImageSourceChangeEvent();

                    // ç»‘å®šç”Ÿæˆå›¾ç‰‡äº‹ä»¶
                    if (generateImageBtn) {
                        generateImageBtn.addEventListener('click', generateResultImage);
                    }
                    return;
                }
            } catch (e) {
                console.error('è§£æURLå‚æ•°å¤±è´¥:', e);
            }
        }

        // é»˜è®¤é€‰ä¸­1äºº
        playerBtns[3].click();

        // æ˜¾ç¤ºåˆå§‹çŠ¶æ€
        initialState.classList.remove('hidden');

        // ç»‘å®šç¦ç”¨å›½å®¶äº‹ä»¶
        disableKoreaAddEventListener();

        // ç»‘å®šå›¾ç‰‡æ¥æºåˆ‡æ¢äº‹ä»¶
        bindImageSourceChangeEvent();

        // ç»‘å®šå›¾ç‰‡æ¨¡æ€æ¡†äº‹ä»¶
        bindImageModalEvents();

        // ç»‘å®šç”Ÿæˆå›¾ç‰‡äº‹ä»¶
        if (generateImageBtn) {
            generateImageBtn.addEventListener('click', generateResultImage);
        }
    });

    // åˆå§‹åŒ–äººæ•°é€‰æ‹©æŒ‰é’®
    playerBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            // ç§»é™¤å…¶ä»–æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
            playerBtns.forEach(b => {
                b.classList.remove('active', 'bg-primary', 'text-white', 'border-primary');
                b.classList.add('btn-outline');
            });

            // æ·»åŠ å½“å‰æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
            btn.classList.add('active', 'bg-primary', 'text-white', 'border-primary');
            btn.classList.remove('btn-outline');

            // æ›´æ–°é€‰ä¸­çš„äººæ•°
            selectedPlayerCount = parseInt(btn.dataset.count);

            // æ›´æ–°æç¤ºæ–‡æœ¬
            playerTip.textContent = `å·²é€‰æ‹© ${selectedPlayerCount} äººï¼Œå°†éšæœºåˆ†é… ${selectedPlayerCount} ä¸ªä¸åŒå›½å®¶`;
            playerTip.classList.add('text-primary');

            // çŸ­æš‚é«˜äº®æç¤º
            playerTip.classList.add('animate-pulse-slow');
            setTimeout(() => {
                playerTip.classList.remove('animate-pulse-slow');
            }, 1000);
        });
    });

    function disableKoreaAddEventListener(){
        disableKorea.addEventListener('change', () => {
            if (disableKorea.checked) {
                disabledCountries.add(5); // æ·»åŠ éŸ©å›½åˆ°ç¦ç”¨åˆ—è¡¨
            } else {
                disabledCountries.delete(5); // ä»ç¦ç”¨åˆ—è¡¨ä¸­ç§»é™¤éŸ©å›½
            }
            updateAvailableCountriesCount();

            // æ›´æ–°URLå‚æ•°
            updateUrlParams();
        });
    }

    // æ–°å¢ï¼šæ›´æ–°å¯ç”¨å›½å®¶æ•°é‡æ˜¾ç¤º
    function updateAvailableCountriesCount() {
        const availableCount = countryDatabase.length - disabledCountries.size;
        availableCountriesCount.textContent = availableCount;
        initialCountryCount.textContent = availableCount;
    }

    // æ–°å¢ï¼šç»‘å®šå›¾ç‰‡æ¥æºåˆ‡æ¢äº‹ä»¶
    // ä¿®æ”¹ bindImageSourceChangeEvent å‡½æ•°
    function bindImageSourceChangeEvent() {
        imageConfigBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const isHidden = imageConfigMenu.classList.contains('hidden');

            // æ›´æ–°æŒ‰é’®çš„ aria-expanded çŠ¶æ€
            imageConfigBtn.setAttribute('aria-expanded', isHidden);

            if (isHidden) {
                // æ˜¾ç¤ºèœå•æ—¶æ·»åŠ åŠ¨ç”»æ•ˆæœ
                imageConfigMenu.classList.remove('hidden');
                setTimeout(() => {
                    imageConfigMenu.style.transform = 'scale(1)';
                    imageConfigMenu.style.opacity = '1';
                }, 10);
            } else {
                // éšè—èœå•æ—¶æ·»åŠ åŠ¨ç”»æ•ˆæœ
                hideImageConfigMenu();
            }
        });

        imageSourceRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                currentImageSourceType = e.target.value;
                updateImageSourceDisplay(); // æ›´æ–°æ˜¾ç¤º

                // å¦‚æœå·²æœ‰æŠ½å–ç»“æœï¼Œé‡æ–°æ¸²æŸ“å›¾ç‰‡
                if (drawnCountries.length > 0) {
                    reRenderCountryImages();
                }

                // æ›´æ–°URLå‚æ•°ï¼ˆå¦‚æœå·²æœ‰ç»“æœï¼‰
                updateUrlParams();

                // é€‰æ‹©åè‡ªåŠ¨éšè—èœå•
                setTimeout(() => {
                    hideImageConfigMenu();
                }, 150);
            });
        });

        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­é…ç½®èœå•
        document.addEventListener('click', (e) => {
            // æ£€æŸ¥ç‚¹å‡»æ˜¯å¦åœ¨é…ç½®èœå•å†…éƒ¨
            if (!imageConfigWrapper.contains(e.target) && e.target !== imageConfigBtn) {
                hideImageConfigMenu();
            }
        });
    }

    // æ–°å¢éšè—èœå•çš„å‡½æ•°ï¼Œå¸¦åŠ¨ç”»æ•ˆæœ
    function hideImageConfigMenu() {
        if (!imageConfigMenu.classList.contains('hidden')) {
            imageConfigMenu.style.transform = 'scale(0.95)';
            imageConfigMenu.style.opacity = '0';
            imageConfigBtn.setAttribute('aria-expanded', 'false');

            setTimeout(() => {
                imageConfigMenu.classList.add('hidden');
            }, 200);
        }
    }


    // æ–°å¢ï¼šç»‘å®šå›¾ç‰‡æ¨¡æ€æ¡†äº‹ä»¶
    function bindImageModalEvents() {
        // å…³é—­æ¨¡æ€æ¡†æŒ‰é’®äº‹ä»¶
        closeImageModal.addEventListener('click', () => {
            closeImageModalHandler();
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        imageModal.addEventListener('click', (e) => {
            if (e.target === imageModal) {
                closeImageModalHandler();
            }
        });

        // é”®ç›˜ESCå…³é—­
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !imageModal.classList.contains('hidden')) {
                closeImageModalHandler();
            }
        });

        // å›¾ç‰‡åŠ è½½äº‹ä»¶
        modalImage.addEventListener('load', () => {
            modalImageLoader.style.transition = 'opacity 0.5s ease';
            modalImageLoader.style.opacity = '0';
            setTimeout(() => {
                modalImageLoader.style.display = 'none';
            }, 500);
            // æ˜¾ç¤ºå›¾ç‰‡
            modalImage.classList.remove('opacity-0');
            // éšè—é”™è¯¯æç¤º
            modalImageError.classList.add('hidden');
        });

        // å›¾ç‰‡åŠ è½½é”™è¯¯äº‹ä»¶
        modalImage.addEventListener('error', () => {
            handleModalImageError();
        });
    }

    // æ–°å¢ï¼šå…³é—­å›¾ç‰‡æ¨¡æ€æ¡†å¤„ç†å‡½æ•°
    function closeImageModalHandler() {
        imageModal.classList.add('hidden');
        document.body.style.overflow = ''; // æ¢å¤æ»šåŠ¨

        // é‡ç½®æ¨¡æ€æ¡†çŠ¶æ€
        modalImage.classList.add('opacity-0');
        modalImageLoader.style.display = 'flex';
        modalImageLoader.style.opacity = '1';
        modalImageError.classList.add('hidden');

        // æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
        modalImage.onload = null;
        modalImage.onerror = null;

        currentModalCountry = null;
        thumbnailNavigation.innerHTML = ''; // æ¸…ç©ºç¼©ç•¥å›¾
    }

    // æ–°å¢ï¼šå¤„ç†æ¨¡æ€æ¡†å›¾ç‰‡åŠ è½½é”™è¯¯
    function handleModalImageError() {
        // æ˜¾ç¤ºé”™è¯¯æç¤º
        modalImageError.classList.remove('hidden');

        // é”™è¯¯å¤„ç†ç­–ç•¥
        if (currentModalCountry) {
            // 1. å¦‚æœå½“å‰æ˜¯æœ¬åœ°å›¾ï¼Œå°è¯•è¿œç¨‹å›¾
            if (currentImageSourceType === 'localImg' && currentModalCountry.image) {
                modalImage.src = currentModalCountry.image;
                return;
            }

            // 2. å°è¯•ä½¿ç”¨å›½å®¶åä½œä¸ºç§å­çš„å¤‡ç”¨å›¾ï¼ˆ4:3æ¯”ä¾‹ï¼‰
            const fallbackUrl = `https://picsum.photos/seed/${currentModalCountry.name}/800/600`;
            if (modalImage.src !== fallbackUrl) {
                modalImage.src = fallbackUrl;
                return;
            }

            // 3. æœ€ç»ˆå¤‡ç”¨å›¾
            modalImage.src = `https://picsum.photos/800/600?grayscale&blur=2`;
        }
    }

    // æ–°å¢ï¼šæ›´æ–°å›¾ç‰‡æ¥æºæ˜¾ç¤º
    function updateImageSourceDisplay() {
        const sourceMap = {
            'image': 'é»˜è®¤è¿œç¨‹å›¾',
            'localImg': 'æœ¬åœ°å›¾'
        };
        currentImageSourceText.textContent = sourceMap[currentImageSourceType];

        // æœ‰ç»“æœæ—¶æ˜¾ç¤ºå›¾ç‰‡æ¥æºä¿¡æ¯
        if (drawnCountries.length > 0) {
            currentImageSource.classList.remove('hidden');
        } else {
            currentImageSource.classList.add('hidden');
        }
    }

    // æ–°å¢ï¼šé‡æ–°æ¸²æŸ“å›½å®¶å›¾ç‰‡ï¼ˆåˆ‡æ¢æ¥æºæ—¶ä½¿ç”¨ï¼‰
    function reRenderCountryImages() {
        const imageElements = countryContainer.querySelectorAll('.image-cover');
        const loaderElements = countryContainer.querySelectorAll('.image-loader');

        drawnCountries.forEach((country, index) => {
            const imageElement = imageElements[index];
            const loaderElement = loaderElements[index];

            // é‡ç½®åŠ è½½çŠ¶æ€
            imageElement.classList.remove('loaded');
            loaderElement.style.opacity = '1';
            loaderElement.style.display = 'flex';
            loaderElement.innerHTML = '<i class="fa fa-circle-o-notch fa-spin text-primary/50"></i>';

            // æ›´æ–°å›¾ç‰‡URL
            const imageUrl = getCountryImageUrl(country);
            imageElement.src = imageUrl;
            imageElement.alt = `${country.name} å°é¢å›¾`;

            // é‡æ–°ç»‘å®šåŠ è½½äº‹ä»¶
            imageElement.onload = function() {
                imageLoaded(loaderElement.id, this);
            };
            imageElement.onerror = function() {
                imageError(loaderElement.id, this, country.name);
            };
        });
    }

    // æ–°å¢ï¼šè·å–å›½å®¶å›¾ç‰‡URLï¼ˆæ ¹æ®å½“å‰æ¥æºï¼‰
    function getCountryImageUrl(country) {
        return country[currentImageSourceType] || country.image; // é™çº§æ–¹æ¡ˆï¼šä¼˜å…ˆå½“å‰æ¥æºï¼Œå¦åˆ™ç”¨é»˜è®¤å›¾
    }

    disableKoreaAddEventListener();
    // æŠ½å–é€»è¾‘
    drawBtn.addEventListener('click', startDraw);
    redrawBtn.addEventListener('click', startDraw);

    // é‡ç½®åŠŸèƒ½
    resetBtn.addEventListener('click', () => {
        // é‡ç½®äººæ•°é€‰æ‹©
        playerBtns.forEach((btn, index) => {
            if (index === 0) {
                btn.classList.add('active', 'bg-primary', 'text-white', 'border-primary');
                btn.classList.remove('btn-outline');
                selectedPlayerCount = 1;
            } else {
                btn.classList.remove('active', 'bg-primary', 'text-white', 'border-primary');
                btn.classList.add('btn-outline');
            }
        });

        // é‡ç½®æç¤º
        playerTip.textContent = "è¯·é€‰æ‹©éœ€è¦åˆ†é…å›½å®¶çš„ç©å®¶äººæ•°";
        playerTip.classList.remove('text-primary');

        // é‡ç½®ç¦ç”¨å›½å®¶é€‰é¡¹ï¼ˆé»˜è®¤ç¦ç”¨éŸ©å›½ï¼‰
        disabledCountries = new Set([5]);
        disableKorea.checked = true;
        updateAvailableCountriesCount();

        // æ˜¾ç¤ºåˆå§‹çŠ¶æ€ï¼Œéšè—ç»“æœ
        resultSection.classList.add('hidden');
        initialState.classList.remove('hidden');
        loadingState.classList.add('hidden');

        // æ¸…ç©ºç»“æœ
        countryContainer.innerHTML = '';
        drawnCountries = [];
        currentSeed = null;

        // æ›´æ–°å›¾ç‰‡æ¥æºæ˜¾ç¤º
        updateImageSourceDisplay();

        // æ›´æ–°URLï¼Œç§»é™¤å‚æ•°
        const url = new URL(window.location.href);
        url.searchParams.delete('countries');
        url.searchParams.delete('count');
        url.searchParams.delete('seed');
        url.searchParams.delete('imageSource'); // ç§»é™¤å›¾ç‰‡æ¥æºå‚æ•°
        url.searchParams.delete('disabled'); // ç§»é™¤ç¦ç”¨å›½å®¶å‚æ•°
        history.pushState({}, document.title, url.toString());
    });

    // åˆ†äº«åŠŸèƒ½
    shareBtn.addEventListener('click', () => {
        if (drawnCountries.length === 0 || !currentSeed) return;

        // ç”Ÿæˆåˆ†äº«URLï¼ˆåŒ…å«å›¾ç‰‡æ¥æºå‚æ•°ï¼‰
        const countryIds = drawnCountries.map(c => c.id).join(',');
        const url = new URL(window.location.href);
        url.searchParams.set('countries', countryIds);
        url.searchParams.set('count', selectedPlayerCount);
        url.searchParams.set('seed', currentSeed);
        url.searchParams.set('imageSource', currentImageSourceType); // æ–°å¢ï¼šæ·»åŠ å›¾ç‰‡æ¥æºå‚æ•°
        url.searchParams.set('disabled', Array.from(disabledCountries).join(',')); // æ–°å¢ï¼šæ·»åŠ ç¦ç”¨å›½å®¶å‚æ•°

        // è®¾ç½®åˆ†äº«é“¾æ¥
        shareUrl.value = url.toString();

        // æ˜¾ç¤ºåˆ†äº«æ¨¡æ€æ¡†
        shareModal.classList.remove('hidden');
    });

    // å…³é—­åˆ†äº«æ¨¡æ€æ¡†
    closeShareModal.addEventListener('click', () => {
        shareModal.classList.add('hidden');
    });

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    shareModal.addEventListener('click', (e) => {
        if (e.target === shareModal) {
            shareModal.classList.add('hidden');
        }
    });

    // å¤åˆ¶é“¾æ¥
    copyUrlBtn.addEventListener('click', () => {
        shareUrl.select();
        document.execCommand('copy');

        // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
        const originalText = copyUrlBtn.innerHTML;
        copyUrlBtn.innerHTML = '<i class="fa fa-check mr-1"></i> å·²å¤åˆ¶';
        copyUrlBtn.classList.add('bg-green-50', 'border-green-200', 'text-green-700');

        setTimeout(() => {
            copyUrlBtn.innerHTML = originalText;
            copyUrlBtn.classList.remove('bg-green-50', 'border-green-200', 'text-green-700');
        }, 2000);
    });

    // æ›´æ–°URLå‚æ•°
    function updateUrlParams() {
        if (currentSeed) {
            const countryIds = drawnCountries.map(c => c.id).join(',');
            const url = new URL(window.location.href);
            url.searchParams.set('countries', countryIds);
            url.searchParams.set('count', selectedPlayerCount);
            url.searchParams.set('seed', currentSeed);
            url.searchParams.set('imageSource', currentImageSourceType);
            url.searchParams.set('disabled', Array.from(disabledCountries).join(','));
            history.pushState({}, document.title, url.toString());
        }
    }

    // å¼€å§‹æŠ½å–å‡½æ•°
    function startDraw() {
        // éªŒè¯é€‰æ‹©çš„äººæ•°
        if (selectedPlayerCount < 1 || selectedPlayerCount > 5) {
            playerTip.textContent = "è¯·é€‰æ‹©1-5äººçš„æœ‰æ•ˆäººæ•°";
            playerTip.classList.add('text-red-500', 'animate-pulse-slow');
            setTimeout(() => {
                playerTip.classList.remove('animate-pulse-slow');
            }, 1000);
            return;
        }

        // æ£€æŸ¥å¯ç”¨å›½å®¶æ•°é‡æ˜¯å¦è¶³å¤Ÿ
        const availableCountries = countryDatabase.filter(country => !disabledCountries.has(country.id));
        if (selectedPlayerCount > availableCountries.length) {
            playerTip.textContent = `å¯é€‰å›½å®¶ä¸è¶³ï¼å½“å‰éœ€è¦${selectedPlayerCount}ä¸ªï¼Œä½†åªæœ‰${availableCountries.length}ä¸ªå¯ç”¨`;
            playerTip.classList.add('text-red-500', 'animate-pulse-slow');
            setTimeout(() => {
                playerTip.classList.remove('animate-pulse-slow');
            }, 1000);
            return;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼Œéšè—å…¶ä»–çŠ¶æ€
        initialState.classList.add('hidden');
        resultSection.classList.add('hidden');
        loadingState.classList.remove('hidden');

        // é‡ç½®åŠ è½½è¿›åº¦
        loadingBar.style.width = '0%';
        loadingText.textContent = `æ­£åœ¨éšæœºé€‰æ‹© ${selectedPlayerCount} ä¸ªå›½å®¶...`;

        // ç”Ÿæˆæ–°çš„éšæœºç§å­
        currentSeed = generateSeed();

        // æ¨¡æ‹ŸåŠ è½½è¿›åº¦
        const progressSteps = 5;
        const stepDuration = 300;
        let currentProgress = 0;

        const progressInterval = setInterval(() => {
            currentProgress += 100 / progressSteps;
            loadingBar.style.width = `${currentProgress}%`;

            // æ›´æ–°åŠ è½½æ–‡æœ¬
            if (currentProgress === 20) loadingText.textContent = "æ­£åœ¨ç­›é€‰å›½å®¶åº“...";
            else if (currentProgress === 40) loadingText.textContent = "æ­£åœ¨éšæœºæ’åº...";
            else if (currentProgress === 60) loadingText.textContent = "æ­£åœ¨é€‰æ‹©åŒ¹é…å›½å®¶...";
            else if (currentProgress === 80) loadingText.textContent = "æ­£åœ¨å‡†å¤‡å±•ç¤ºç»“æœ...";

            if (currentProgress >= 100) {
                clearInterval(progressInterval);

                // å®ŒæˆåŠ è½½åç”Ÿæˆç»“æœ
                setTimeout(() => {
                    generateDrawResult();

                    // æ›´æ–°URLå‚æ•°ï¼ˆåŒ…å«å›¾ç‰‡æ¥æºå’Œç¦ç”¨å›½å®¶ï¼‰
                    updateUrlParams();
                }, 500);
            }
        }, stepDuration);
    }

    // ç”ŸæˆæŠ½å–ç»“æœ
    function generateDrawResult(showLoading = true) {
        if (showLoading) {
            // ä»å›½å®¶åº“ä¸­éšæœºé€‰æ‹©æŒ‡å®šæ•°é‡çš„ä¸åŒå›½å®¶
            drawnCountries = getRandomCountries(selectedPlayerCount);
        }

        // æ›´æ–°ç»“æœè®¡æ•°
        resultCount.textContent = `å…± ${drawnCountries.length} ä¸ªå›½å®¶`;

        // æ›´æ–°å›¾ç‰‡æ¥æºæ˜¾ç¤º
        updateImageSourceDisplay();

        // æ¸…ç©ºå®¹å™¨
        countryContainer.innerHTML = '';

        // åˆ›å»ºå›½å®¶å¡ç‰‡
        drawnCountries.forEach((country, index) => {
            // è·å–å½“å‰æ¥æºçš„å›¾ç‰‡URL
            const imageUrl = getCountryImageUrl(country);
            const loaderId = `loader-${index}-${Date.now()}`; // ç¡®ä¿loaderIDå”¯ä¸€

            // åˆ›å»ºå¡ç‰‡å…ƒç´ 
            const countryCard = document.createElement('div');
            countryCard.className = 'bg-white rounded-xl shadow-md overflow-hidden card-hover animate-slide-up';
            countryCard.style.animationDelay = `${index * 100}ms`;

            // æ„å»ºç‹æœå›¾ç‰‡HTML
            let dynastyImagesHtml = '';
            if (country.dynasties && country.dynasties.length > 0) {
                dynastyImagesHtml = `
                    <div class="mt-2">
                        <div class="text-xs text-gray-500 mb-1">ç‹æœå›¾ç‰‡:</div>
                        <div class="flex gap-1 overflow-x-auto pb-1">
                            ${country.dynasties.map(dynastyImg => `
                                <div class="flex-shrink-0" style="width: 40px; height: 30px;">
                                    <img src="${dynastyImg}" alt="ç‹æœå›¾ç‰‡"
                                         class="w-full h-full object-cover rounded border">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // è®¾ç½®å¡ç‰‡å†…å®¹ï¼ŒåŒ…å«å›¾ç‰‡åŠ è½½çŠ¶æ€
            countryCard.innerHTML = `
                <div class="image-container">
                    <!-- å›¾ç‰‡åŠ è½½æŒ‡ç¤ºå™¨ -->
            <div class="image-loader" id="${loaderId}">
            <i class="fa fa-circle-o-notch fa-spin text-primary/50"></i>
            </div>
            <img src="${imageUrl}" alt="${country.name} å°é¢å›¾"
            class="image-cover"
            data-country-id="${country.id}">
            <div class="absolute top-3 left-3 bg-primary/80 text-white text-xs font-medium px-2 py-1 rounded">
            ç©å®¶ ${index + 1}
            </div>
            </div>
            <div class="p-4">
            <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold text-lg flex items-center">
            ${country.flag} ${country.name}
            </h3>
            <span class="text-xs text-gray-400">
            #${index + 1}
            </span>
            </div>
            ${dynastyImagesHtml}
            <button class="view-details-btn w-full text-sm text-primary hover:text-primary/80 transition-colors flex items-center justify-center gap-1 py-1 mt-2"
            data-country-id="${country.id}">
            <i class="fa fa-search-plus"></i> æŸ¥çœ‹è¯¦æƒ…
            </button>
            </div>
            `;

            // æ·»åŠ åˆ°å®¹å™¨
            countryContainer.appendChild(countryCard);

            // è·å–å›¾ç‰‡å…ƒç´ å¹¶ç»‘å®šåŠ è½½äº‹ä»¶
            const imgElement = countryCard.querySelector('.image-cover');
            imgElement.onload = function() {
                imageLoaded(loaderId, this);
            };
            imgElement.onerror = function() {
                imageError(loaderId, this, country.name);
            };

            // è¯¦æƒ…æŒ‰é’®äº‹ä»¶
            const detailsBtn = countryCard.querySelector('.view-details-btn');
            detailsBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                // æ˜¾ç¤ºå›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡†
                showImageModal(country);
            });
        });

        // æ˜¾ç¤ºç»“æœï¼Œéšè—åŠ è½½çŠ¶æ€
        loadingState.classList.add('hidden');
        resultSection.classList.remove('hidden');
    }

    // å›¾ç‰‡åŠ è½½å®Œæˆå¤„ç†å‡½æ•°
    function imageLoaded(loaderId, imageElement) {
        const loader = document.getElementById(loaderId);
        if (loader) {
            // å¹³æ»‘éšè—åŠ è½½æŒ‡ç¤ºå™¨
            loader.style.transition = 'opacity 0.3s ease';
            loader.style.opacity = '0';
            setTimeout(() => {
                loader.style.display = 'none';
            }, 300);
        }
        // ç«‹å³æ ‡è®°å›¾ç‰‡ä¸ºå·²åŠ è½½ï¼Œè§¦å‘æ˜¾ç¤ºåŠ¨ç”»
        imageElement.classList.add('loaded');
    }

    // å›¾ç‰‡åŠ è½½å¤±è´¥å¤„ç†å‡½æ•°ï¼ˆé€‚é…ä¸åŒæ¥æºï¼‰
    function imageError(loaderId, imageElement, countryName) {
        const loader = document.getElementById(loaderId);
        if (loader) {
            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯æ›¿ä»£åŠ è½½æŒ‡ç¤ºå™¨
            loader.innerHTML = `<i class="fa fa-exclamation-triangle text-amber-500"></i>`;
            loader.classList.add('bg-amber-50');
            }

        // å¤±è´¥é™çº§ç­–ç•¥ï¼šåˆ‡æ¢åˆ°å¦ä¸€ç§æ¥æºï¼Œæœ€ç»ˆç”¨å¤‡ç”¨å›¾
        const country = countryDatabase.find(c => c.name === countryName);
        if (country) {
            if (currentImageSourceType === 'localImg' && imageElement.src !== country.image) {
                // æœ¬åœ°å›¾åŠ è½½å¤±è´¥ï¼Œå°è¯•è¿œç¨‹å›¾
                imageElement.src = country.image;
                return;
            } else if (currentImageSourceType === 'image' && country.localImg && imageElement.src !== country.localImg) {
                // è¿œç¨‹å›¾åŠ è½½å¤±è´¥ï¼Œå°è¯•æœ¬åœ°å›¾
                imageElement.src = country.localImg;
                return;
            }
        }

        // æœ€ç»ˆå¤‡ç”¨å›¾ï¼ˆ4:3æ¯”ä¾‹ï¼‰
        imageElement.src = `https://picsum.photos/seed/${countryName}/600/450`;
        imageElement.alt = `${countryName} å›¾ç‰‡åŠ è½½å¤±è´¥`;
        imageElement.classList.add('loaded'); // å¼ºåˆ¶æ˜¾ç¤ºå¤‡ç”¨å›¾
    }

    // æ˜¾ç¤ºå›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡†ï¼ˆæ ¸å¿ƒä¿®å¤å‡½æ•°ï¼‰
    function showImageModal(country) {
        if (!country) return;

        // ä¿å­˜å½“å‰æ˜¾ç¤ºçš„å›½å®¶
        currentModalCountry = country;

        // æ›´æ–°æ¨¡æ€æ¡†æ ‡é¢˜
        const sourceText = currentImageSourceType === 'image' ? 'è¿œç¨‹å›¾' : 'æœ¬åœ°å›¾';
        modalTitle.innerHTML = `${country.flag} ${country.name} (${sourceText})`;

        // è·å–å½“å‰æ¥æºçš„å›¾ç‰‡URL
        const imageUrl = getCountryImageUrl(country);

        // è®¾ç½®å›¾ç‰‡ä¿¡æ¯
        modalImage.src = imageUrl;
        modalImage.alt = `${country.name} è¯¦æƒ…å›¾`;

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        imageModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨

        // é‡ç½®åŠ è½½çŠ¶æ€
        modalImageLoader.style.display = 'flex';
        modalImageLoader.style.opacity = '1';
        modalImage.classList.add('opacity-0');
        modalImageError.classList.add('hidden');

        // ç¡®ä¿å›¾ç‰‡åŠ è½½äº‹ä»¶æ­£ç¡®ç»‘å®š
        modalImage.onload = function() {
            modalImageLoader.style.transition = 'opacity 0.5s ease';
            modalImageLoader.style.opacity = '0';
            setTimeout(() => {
                modalImageLoader.style.display = 'none';
            }, 500);
            modalImage.classList.remove('opacity-0');
            modalImageError.classList.add('hidden');
        };

        modalImage.onerror = function() {
            handleModalImageError();
        };

        // åˆ›å»ºç¼©ç•¥å›¾å¯¼èˆª
        createThumbnailNavigation(country, imageUrl);
    }

    // åˆ›å»ºç¼©ç•¥å›¾å¯¼èˆª
    function createThumbnailNavigation(country, mainImageUrl) {
        // æ¸…ç©ºä¹‹å‰çš„ç¼©ç•¥å›¾
        thumbnailNavigation.innerHTML = '';

        // æ”¶é›†æ‰€æœ‰å›¾ç‰‡URLï¼ˆä¸»å›¾ + ç‹æœå›¾ç‰‡ï¼‰
        const allImages = [mainImageUrl];
        if (country.dynasties && country.dynasties.length > 0) {
            allImages.push(...country.dynasties);
        }

        // å¦‚æœåªæœ‰ä¸€å¼ å›¾ç‰‡ï¼Œä¸éœ€è¦ç¼©ç•¥å›¾å¯¼èˆª
        if (allImages.length <= 1) {
            return;
        }

        // åˆ›å»ºç¼©ç•¥å›¾å®¹å™¨
        const thumbnailContainer = document.createElement('div');
        thumbnailContainer.className = 'flex flex-wrap justify-center gap-2';

        // æ·»åŠ æ ‡é¢˜
        const title = document.createElement('div');
        title.className = 'w-full text-center text-sm font-medium text-gray-700 mb-1';
        title.textContent = 'ç›¸å…³å›¾ç‰‡:';
        thumbnailContainer.appendChild(title);

        // åˆ›å»ºç¼©ç•¥å›¾
        allImages.forEach((imgUrl, index) => {
            const thumbnail = document.createElement('img');
            thumbnail.src = imgUrl;
            thumbnail.className = 'dynasty-thumbnail';
            thumbnail.alt = `å›¾ç‰‡ ${index + 1}`;
            thumbnail.dataset.src = imgUrl;

            // ç¬¬ä¸€å¼ å›¾ç‰‡è®¾ä¸ºæ¿€æ´»çŠ¶æ€
            if (index === 0) {
                thumbnail.classList.add('active');
            }

            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            thumbnail.addEventListener('click', function() {
                // æ›´æ–°æ¿€æ´»çŠ¶æ€
                thumbnailContainer.querySelectorAll('.dynasty-thumbnail').forEach(thumb => {
                    thumb.classList.remove('active');
                });
                this.classList.add('active');

                // æ›´æ¢ä¸»å›¾
                modalImage.src = this.dataset.src;
                modalImage.classList.add('opacity-0');
                modalImageLoader.style.display = 'flex';
                modalImageLoader.style.opacity = '1';

                // é‡æ–°ç»‘å®šåŠ è½½å’Œé”™è¯¯äº‹ä»¶ä»¥å¤„ç†æ–°å›¾ç‰‡
                modalImage.onload = function() {
                    modalImageLoader.style.transition = 'opacity 0.5s ease';
                    modalImageLoader.style.opacity = '0';
                    setTimeout(() => {
                        modalImageLoader.style.display = 'none';
                    }, 500);
                    modalImage.classList.remove('opacity-0');
                    modalImageError.classList.add('hidden');
                };

                modalImage.onerror = function() {
                    handleModalImageError();
                };
            });

            thumbnailContainer.appendChild(thumbnail);
        });

        thumbnailNavigation.appendChild(thumbnailContainer);
    }

    // ç”Ÿæˆéšæœºç§å­
    function generateSeed() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    }

    // åŸºäºç§å­çš„éšæœºæ•°ç”Ÿæˆå™¨
    function seededRandom(seed) {
        // ç®€å•çš„çº¿æ€§åŒä½™ç”Ÿæˆå™¨
        let s = seed % 2147483647;
        if (s <= 0) s += 2147483646;
        return function() {
            s = s * 16807 % 2147483647;
            return s / 2147483647;
        };
    }

    // ä»å›½å®¶åº“ä¸­è·å–æŒ‡å®šæ•°é‡çš„éšæœºä¸åŒå›½å®¶
    function getRandomCountries(count) {
        // è¿‡æ»¤æ‰è¢«ç¦ç”¨çš„å›½å®¶
        const countryPool = countryDatabase.filter(country => !disabledCountries.has(country.id));
        console.log(countryPool);
        console.log(disabledCountries);
        const selectedCountries = [];

        // åˆ›å»ºåŸºäºå½“å‰ç§å­çš„éšæœºæ•°ç”Ÿæˆå™¨
        const random = seededRandom(currentSeed ? currentSeed.hashCode() : Date.now());

        // éšæœºé€‰æ‹©æŒ‡å®šæ•°é‡çš„å›½å®¶
        for (let i = 0; i < count && countryPool.length > 0; i++) {
            // ç”Ÿæˆéšæœºç´¢å¼•
            const randomIndex = Math.floor(random() * countryPool.length);

            // å–å‡ºé€‰ä¸­çš„å›½å®¶å¹¶æ·»åŠ åˆ°ç»“æœä¸­
            selectedCountries.push(countryPool[randomIndex]);

            // ä»æ± ä¸­ç§»é™¤å·²é€‰ä¸­çš„å›½å®¶ï¼ˆé¿å…é‡å¤ï¼‰
            countryPool.splice(randomIndex, 1);
        }

        return selectedCountries;
    }

    // ä¸ºå­—ç¬¦ä¸²æ·»åŠ å“ˆå¸Œç æ–¹æ³•ï¼Œç”¨äºå°†ç§å­è½¬æ¢ä¸ºæ•°å­—
    String.prototype.hashCode = function() {
        let hash = 0;
        for (let i = 0; i < this.length; i++) {
            const char = this.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // è½¬æ¢ä¸º32ä½æ•´æ•°
        }
        return Math.abs(hash);
    };

    //  æ›¿æ¢æ•´ä¸ª generateResultImage å‡½æ•°ä¸ºä»¥ä¸‹ä»£ç 
    function generateResultImage() {
        if (drawnCountries.length === 0) return;

        // å¡«å……ç”Ÿæˆå™¨å†…å®¹
        genPlayerCount.textContent = selectedPlayerCount;
        generatedCountries.innerHTML = '';

        // ä¸ºæ¯ä¸ªå›½å®¶åˆ›å»ºå†…å®¹
        drawnCountries.forEach((country, index) => {
            const countryDiv = document.createElement('div');
            countryDiv.className = 'border border-gray-200 rounded-lg p-4';

            // è·å–å½“å‰å›¾ç‰‡æ¥æºçš„URL
            const imageUrl = getCountryImageUrl(country);

            // æ„å»ºç‹æœå›¾ç‰‡HTML
            let dynastyImagesHtml = '';
            if (country.dynasties && country.dynasties.length > 0) {
                dynastyImagesHtml = `
                <div class="mt-3">
                    <div class="text-sm font-medium text-gray-700 mb-2">ç‹æœå›¾ç‰‡:</div>
                    <div class="flex flex-wrap gap-2">
                        ${country.dynasties.map((dynastyImg, i) => `
                            <div class="flex flex-col items-center">
                                <img src="${dynastyImg}"
                                     alt="${country.name} ç‹æœå›¾ç‰‡ ${i+1}"
                                     class="w-32 h-50 object-cover rounded border">
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            }

            countryDiv.innerHTML = `
            <div class="flex items-center mb-3">
                <span class="text-lg mr-2">${country.flag}</span>
                <h3 class="text-xl font-bold text-gray-800">${country.name}</h3>
                <span class="ml-auto bg-blue-600 text-white text-sm font-medium px-2 py-1 rounded">
                    ç©å®¶ ${index + 1}
                </span>
            </div>

            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-shrink-0">
                    <img src="${imageUrl}"
                         alt="${country.name} å°é¢å›¾"
                         class="w-560 h-420 object-contain rounded border">
                </div>
                <div class="flex-grow">
                    <div class="text-gray-700 mb-2">
                        <p><strong>å›½å®¶ID:</strong> ${country.id}</p>
                    </div>
                    ${dynastyImagesHtml}
                </div>
            </div>
        `;

            generatedCountries.appendChild(countryDiv);
        });

        // ä¸ºæ‰€æœ‰å›¾ç‰‡å…ƒç´ æ·»åŠ  crossorigin å±æ€§
        const imgElements = generatedCountries.querySelectorAll('img');
        imgElements.forEach(img => {
            img.crossOrigin = 'anonymous';
        });

        // ä½¿ç”¨html2canvasç”Ÿæˆå›¾ç‰‡
        // ç­‰å¾…å›¾ç‰‡åŠ è½½å®Œæˆåå†ç”Ÿæˆ
        setTimeout(() => {
            html2canvas(imageGenerator, {
                scale: 3,
                useCORS: true,
                backgroundColor: '#ffffff',
                logging: false,
                allowTaint: true,
                pixelRatio: window.devicePixelRatio || 1,
                width: imageGenerator.scrollWidth,
                height: imageGenerator.scrollHeight,
                onclone: (clonedDoc) => {
                    // å¾®ä¿¡ä¸­çš„ä¸€äº›ç‰¹æ®Šå¤„ç†
                    const allElements = clonedDoc.querySelectorAll('*');
                    allElements.forEach(element => {
                        const styles = window.getComputedStyle(element);

                        // å¤„ç†å¯èƒ½å¯¼è‡´é—®é¢˜çš„é¢œè‰²å€¼
                        if (styles.color && styles.color.includes('oklch')) {
                            element.style.color = '#000000';
                        }
                        if (styles.backgroundColor && styles.backgroundColor.includes('oklch')) {
                            element.style.backgroundColor = '#ffffff';
                        }
                        if (styles.borderColor && styles.borderColor.includes('oklch')) {
                            element.style.borderColor = '#cccccc';
                        }
                    });

                    // ç¡®ä¿æ‰€æœ‰å›¾ç‰‡éƒ½æœ‰crossoriginå±æ€§
                    const images = clonedDoc.querySelectorAll('img');
                    images.forEach(img => {
                        img.crossOrigin = 'anonymous';
                    });
                }
            }).then(canvas => {
                // æ£€æµ‹æ˜¯å¦åœ¨å¾®ä¿¡ç¯å¢ƒä¸­
                const isWechat = /MicroMessenger/i.test(navigator.userAgent);

                if (isWechat) {
                    // å¾®ä¿¡ç‰¹æ®Šå¤„ç†ï¼šç›´æ¥æ˜¾ç¤ºå›¾ç‰‡ä¾›ç”¨æˆ·é•¿æŒ‰ä¿å­˜
                    const dataUrl = canvas.toDataURL('image/png', 0.9);

                    // åˆ›å»ºä¸€ä¸ªæ¨¡æ€æ¡†æ˜¾ç¤ºå›¾ç‰‡
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    z-index: 10000;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                `;

                    const content = document.createElement('div');
                    content.style.cssText = `
                    background: white;
                    border-radius: 10px;
                    padding: 20px;
                    max-width: 90%;
                    max-height: 80%;
                    text-align: center;
                `;

                    const title = document.createElement('h3');
                    title.textContent = 'é•¿æŒ‰å›¾ç‰‡ä¿å­˜åˆ°æ‰‹æœº';
                    title.style.cssText = `
                    margin-top: 0;
                    margin-bottom: 15px;
                    color: #333;
                `;

                    const img = document.createElement('img');
                    img.src = dataUrl;
                    img.style.cssText = `
                    max-width: 100%;
                    max-height: 70vh;
                    border-radius: 8px;
                `;

                    const closeBtn = document.createElement('button');
                    closeBtn.textContent = 'å…³é—­';
                    closeBtn.style.cssText = `
                    margin-top: 15px;
                    padding: 10px 20px;
                    background: #2563EB;
                    color: white;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                `;

                    closeBtn.onclick = () => {
                        document.body.removeChild(modal);
                    };

                    content.appendChild(title);
                    content.appendChild(img);
                    content.appendChild(closeBtn);
                    modal.appendChild(content);
                    document.body.appendChild(modal);

                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    showImageGenerationSuccess();
                } else {
                    // éå¾®ä¿¡ç¯å¢ƒä½¿ç”¨ä¼ ç»Ÿä¸‹è½½æ–¹å¼
                    canvas.toBlob((blob) => {
                        // åˆ›å»ºä¸€ä¸ªä¸´æ—¶URL
                        const url = URL.createObjectURL(blob);

                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `éšæœºå›½å®¶æŠ½å–ç»“æœ_${new Date().toLocaleDateString()}_${Date.now().toString()}.png`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);

                        // æ¸…ç†ä¸´æ—¶URL
                        setTimeout(() => URL.revokeObjectURL(url), 1000);

                        // æ˜¾ç¤ºæˆåŠŸæç¤º
                        showImageGenerationSuccess();
                    }, 'image/png', 0.9);
                }
            }).catch(err => {
                console.error('å›¾ç‰‡ç”Ÿæˆå¤±è´¥:', err);
                alert('å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼Œå¯èƒ½æ˜¯ç”±äºå›¾ç‰‡èµ„æºè·¨åŸŸé—®é¢˜ã€‚è¯·å°è¯•åˆ‡æ¢åˆ°è¿œç¨‹å›¾ç‰‡æºå†ç”Ÿæˆã€‚');
            });

        }, 500); // ç­‰å¾…å†…å®¹æ¸²æŸ“
    }

    // æ˜¾ç¤ºå›¾ç‰‡ç”ŸæˆæˆåŠŸæç¤º
    // ä¿®æ”¹ showImageGenerationSuccess å‡½æ•°
    function showImageGenerationSuccess() {
        const isWechat = /MicroMessenger/i.test(navigator.userAgent);
        const successMessage = isWechat ?
            '<i class="fa fa-info-circle mr-2"></i> è¯·åœ¨æ–°çª—å£ä¸­é•¿æŒ‰ä¿å­˜å›¾ç‰‡' :
            '<i class="fa fa-check mr-2"></i> å›¾ç‰‡å·²ä¸‹è½½';

        const originalText = generateImageBtn.innerHTML;
        generateImageBtn.innerHTML = successMessage;
        generateImageBtn.classList.remove('btn-primary');
        generateImageBtn.classList.add('bg-green-100', 'text-green-700');

        setTimeout(() => {
            generateImageBtn.innerHTML = originalText;
            generateImageBtn.classList.add('btn-primary');
            generateImageBtn.classList.remove('bg-green-100', 'text-green-700');
        }, 3000);
    }

    function openUrlInWechat(url) {
        // åˆ›å»ºä¸€ä¸ªéšè—çš„ a æ ‡ç­¾
        const a = document.createElement('a');
        a.href = url;
        a.target = '_blank'; // å°è¯•åœ¨æ–°çª—å£æ‰“å¼€ï¼ˆå¾®ä¿¡å¯èƒ½ä»ä¼šåœ¨å½“å‰çª—å£æ‰“å¼€ï¼Œä½†èƒ½è·³è½¬ï¼‰
        // è§¦å‘ç‚¹å‡»
        document.body.appendChild(a);
        a.click();
        // ç§»é™¤ä¸´æ—¶æ ‡ç­¾
        document.body.removeChild(a);
    }

</script>

<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?48d1a3725fd4ddb5c485a5d24702815d";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>


</body>
</html>
