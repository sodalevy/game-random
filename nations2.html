<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éšæœºå›½å®¶å›¾ç‰‡æŠ½å–</title>
    <!-- å¼•å…¥Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <!-- é…ç½®Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563EB',
                        secondary: '#4B5563',
                        accent: '#F59E0B',
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s ease-in-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                },
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-hover {
                @apply transition-all duration-300 hover:shadow-xl hover:scale-[1.02];
            }
            /* 1. å…³é”®ä¿®æ”¹ï¼šå°†å›¾ç‰‡å®¹å™¨æ¯”ä¾‹ä»3:2ï¼ˆ66.67%ï¼‰æ”¹ä¸º4:3ï¼ˆ75%ï¼‰ï¼Œæ›´é€‚åˆé£æ™¯å›¾å®Œæ•´æ˜¾ç¤º */
            .image-container {
                @apply relative overflow-hidden rounded-t-lg bg-gray-100;
                padding-top: 75%; /* 4:3 æ¯”ä¾‹ï¼ˆé«˜åº¦=å®½åº¦*0.75ï¼‰ï¼Œé¿å…é£æ™¯å›¾ä¸Šä¸‹è£å‰ª */
            }
            /* 2. å…³é”®ä¿®æ”¹ï¼šå›¾ç‰‡æ”¹ä¸º"å®Œæ•´åŒ…å«"æ¨¡å¼ï¼ˆobject-containï¼‰ï¼Œç¡®ä¿ç”»é¢ä¸è£å‰ª */
            .image-cover {
                @apply absolute inset-0 w-full h-full object-contain transition-all duration-700 opacity-0;
                background-color: #f3f4f6; /* å›¾ç‰‡æœªå¡«æ»¡åŒºåŸŸç”¨æµ…ç°èƒŒæ™¯è¿‡æ¸¡ï¼Œé¿å…ç©ºç™½çªå…€ */
            }
            .image-cover.loaded {
                @apply opacity-100;
            }
            /* 3. ä¼˜åŒ– hover æ•ˆæœï¼šç¼©æ”¾å¹…åº¦å‡å°ï¼Œé¿å…è¿‡åº¦è£å‰ª */
            .card-link:hover .image-cover {
                @apply scale-105; /* ä»scale-110æ”¹ä¸ºscale-105ï¼Œå‡å°‘ç¼©æ”¾å¯¼è‡´çš„è¾¹ç¼˜è£å‰ª */
            }
            .btn-primary {
                @apply bg-primary hover:bg-primary/90 text-white font-medium py-3 px-6 rounded-lg transition-all duration-300 flex items-center justify-center gap-2 shadow-md hover:shadow-lg;
            }
            .btn-outline {
                @apply border border-gray-300 hover:border-primary text-gray-700 hover:text-primary font-medium py-2 px-4 rounded-lg transition-all duration-300;
            }
            .image-loader {
                @apply absolute inset-0 flex items-center justify-center bg-gray-100;
            }
            .share-btn {
                @apply text-sm text-gray-600 hover:text-primary transition-colors flex items-center gap-1;
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-gray-800 min-h-screen flex flex-col">
<!-- é¡µé¢å¤´éƒ¨ -->
<header class="bg-white shadow-sm sticky top-0 z-30">
    <div class="container mx-auto px-4 py-5">
        <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
            <h1 class="text-[clamp(1.5rem,3vw,2.2rem)] font-bold text-gray-900 flex items-center">
                <i class="fa fa-globe text-primary mr-3 text-2xl"></i>
                éšæœºå›½å®¶å›¾ç‰‡æŠ½å–
            </h1>
            <div class="flex items-center gap-3">
          <span id="countryCount" class="text-sm text-secondary bg-gray-100 px-3 py-1.5 rounded-full">
            å›½å®¶åº“: 17ä¸ª
          </span>
                <button id="resetBtn" class="btn-outline text-sm">
                    <i class="fa fa-refresh mr-1"></i> é‡ç½®
                </button>
            </div>
        </div>
    </div>
</header>

<!-- ä¸»è¦å†…å®¹åŒº -->
<main class="flex-grow container mx-auto px-4 py-8">
    <!-- é€‰æ‹©åŒºåŸŸ -->
    <section class="bg-white rounded-xl shadow-md p-6 mb-8 max-w-3xl mx-auto animate-fade-in">
        <h2 class="text-xl font-semibold mb-4 flex items-center">
            <i class="fa fa-cog text-primary mr-2"></i> æŠ½å–è®¾ç½®
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- äººæ•°é€‰æ‹© -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©ç©å®¶äººæ•° (1-5äºº)</label>
                <div class="flex flex-wrap gap-2">
                    <button class="player-btn btn-outline active bg-primary text-white border-primary" data-count="1">1äºº</button>
                    <button class="player-btn btn-outline" data-count="2">2äºº</button>
                    <button class="player-btn btn-outline" data-count="3">3äºº</button>
                    <button class="player-btn btn-outline" data-count="4">4äºº</button>
                    <button class="player-btn btn-outline" data-count="5">5äºº</button>
                </div>
                <p id="playerTip" class="mt-2 text-sm text-gray-500">è¯·é€‰æ‹©éœ€è¦åˆ†é…å›½å®¶çš„ç©å®¶äººæ•°</p>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="flex flex-col justify-end">
                <button id="drawBtn" class="btn-primary w-full">
                    <i class="fa fa-random"></i> å¼€å§‹éšæœºæŠ½å–
                </button>
                <p class="mt-2 text-xs text-gray-400 text-center">
                    æ¯æ¬¡æŠ½å–å°†ä»17ä¸ªå›½å®¶ä¸­éšæœºé€‰æ‹©å¯¹åº”äººæ•°çš„ä¸åŒå›½å®¶
                </p>
            </div>
        </div>
    </section>

    <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
    <section id="resultSection" class="hidden">
        <div class="flex flex-wrap justify-between items-center mb-6 max-w-6xl mx-auto gap-4">
            <h2 class="text-xl font-semibold flex items-center">
                <i class="fa fa-trophy text-accent mr-2"></i> æŠ½å–ç»“æœ
                <span id="resultCount" class="ml-2 text-sm text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full"></span>
            </h2>
            <div class="flex gap-3">
                <button id="shareBtn" class="btn-outline">
                    <i class="fa fa-share-alt mr-1"></i> åˆ†äº«ç»“æœ
                </button>
                <button id="redrawBtn" class="btn-outline">
                    <i class="fa fa-refresh mr-1"></i> é‡æ–°æŠ½å–
                </button>
            </div>
        </div>

        <!-- å›½å®¶å¡ç‰‡å®¹å™¨ -->
        <div id="countryContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 max-w-6xl mx-auto">
            <!-- å›½å®¶å¡ç‰‡å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </section>

    <!-- åˆå§‹çŠ¶æ€æç¤º -->
    <section id="initialState" class="text-center py-16 max-w-2xl mx-auto animate-fade-in">
        <div class="bg-white rounded-xl shadow-sm p-8">
            <div class="w-20 h-20 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa fa-globe text-primary text-3xl"></i>
            </div>
            <h3 class="text-xl font-semibold mb-2">å‡†å¤‡å¼€å§‹æŠ½å–</h3>
            <p class="text-gray-500 mb-6">è¯·åœ¨ä¸Šæ–¹é€‰æ‹©ç©å®¶äººæ•°å¹¶ç‚¹å‡»"å¼€å§‹éšæœºæŠ½å–"æŒ‰é’®</p>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 max-w-md mx-auto">
                <div class="bg-gray-100 rounded-lg p-3 text-center text-sm">
                    <div class="font-medium">17</div>
                    <div class="text-xs text-gray-500">å¯é€‰å›½å®¶</div>
                </div>
                <div class="bg-gray-100 rounded-lg p-3 text-center text-sm">
                    <div class="font-medium">1-5</div>
                    <div class="text-xs text-gray-500">æ”¯æŒäººæ•°</div>
                </div>
                <div class="bg-gray-100 rounded-lg p-3 text-center text-sm">
                    <div class="font-medium">4:3</div> <!-- æ›´æ–°æ¯”ä¾‹æç¤º -->
                    <div class="text-xs text-gray-500">å›¾ç‰‡æ¯”ä¾‹</div>
                </div>
                <div class="bg-gray-100 rounded-lg p-3 text-center text-sm">
                    <div class="font-medium">å¯åˆ†äº«</div>
                    <div class="text-xs text-gray-500">ç»“æœé“¾æ¥</div>
                </div>
            </div>
        </div>
    </section>

    <!-- åŠ è½½çŠ¶æ€ -->
    <section id="loadingState" class="hidden text-center py-16 max-w-2xl mx-auto">
        <div class="bg-white rounded-xl shadow-sm p-8">
            <div class="w-20 h-20 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa fa-circle-o-notch fa-spin text-primary text-3xl"></i>
            </div>
            <h3 class="text-xl font-semibold mb-2">æ­£åœ¨æŠ½å–å›½å®¶</h3>
            <p class="text-gray-500" id="loadingText">è¯·ç¨å€™...</p>
            <div class="mt-6 w-full bg-gray-200 rounded-full h-2.5">
                <div id="loadingBar" class="bg-primary h-2.5 rounded-full w-0 transition-all duration-1500"></div>
            </div>
        </div>
    </section>
</main>

<!-- åˆ†äº«æ¨¡æ€æ¡† -->
<div id="shareModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-xl max-w-md w-full p-6 animate-fade-in">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">åˆ†äº«ç»“æœ</h3>
            <button id="closeShareModal" class="text-gray-500 hover:text-gray-800">
                <i class="fa fa-times"></i>
            </button>
        </div>
        <p class="text-gray-600 mb-4">å¤åˆ¶ä¸‹é¢çš„é“¾æ¥ï¼Œåˆ†äº«ç»™ä»–äººæŸ¥çœ‹ç›¸åŒçš„æŠ½å–ç»“æœï¼š</p>
        <div class="flex gap-2 mb-4">
            <input type="text" id="shareUrl" class="flex-grow px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" readonly>
            <button id="copyUrlBtn" class="btn-outline whitespace-nowrap">
                <i class="fa fa-copy mr-1"></i> å¤åˆ¶
            </button>
        </div>
        <div class="flex gap-2">
            <button class="btn-outline flex-1" id="shareWechatBtn">
                <i class="fa fa-weixin text-green-500 mr-1"></i> å¾®ä¿¡
            </button>
            <button class="btn-outline flex-1" id="shareQQBtn">
                <i class="fa fa-qq text-blue-500 mr-1"></i> QQ
            </button>
        </div>
    </div>
</div>

<!-- é¡µè„š -->
<footer class="bg-gray-900 text-gray-300 mt-12">
    <div class="container mx-auto px-4 py-6">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
            <p class="text-sm">Â© 2025 éšæœºå›½å®¶å›¾ç‰‡æŠ½å–å·¥å…· | åŒ…å«17ä¸ªå›½å®¶çš„ç²¾ç¾å›¾ç‰‡</p>
            <div class="flex gap-4">
                <a href="#" class="text-gray-400 hover:text-white transition-colors text-sm">
                    <i class="fa fa-question-circle mr-1"></i> ä½¿ç”¨å¸®åŠ©
                </a>
                <a href="#" class="text-gray-400 hover:text-white transition-colors text-sm">
                    <i class="fa fa-image mr-1"></i> å›¾ç‰‡æ¥æº
                </a>
            </div>
        </div>
    </div>
</footer>

<!-- JavaScript -->
<script>
    // 17ä¸ªå›½å®¶çš„æ•°æ® - åŒ…å«å›½å®¶åç§°å’Œå°é¢å›¾
    const countryDatabase = [
        { name: "ä¸­å›½", image: "https://game-random.oss-cn-guangzhou.aliyuncs.com/doc/china.jpg", flag: "ğŸ‡¨ğŸ‡³", id: 0 },
        { name: "ç¾å›½", image: "https://game-random.oss-cn-guangzhou.aliyuncs.com/doc/america.jpg", flag: "ğŸ‡ºğŸ‡¸", id: 1 },
        { name: "åŸƒå¡ä¿„æ¯”äºš", image: "https://game-random.oss-cn-guangzhou.aliyuncs.com/doc/ethiopia.jpg", flag: "ğŸ‡ªğŸ‡¹", id: 2 },
        { name: "å°åº¦", image: "https://game-random.oss-cn-guangzhou.aliyuncs.com/doc/india.jpg", flag: "ğŸ‡®ğŸ‡³", id: 3 },
        { name: "æ—¥æœ¬", image: "https://game-random.oss-cn-guangzhou.aliyuncs.com/doc/japan.jpg", flag: "ğŸ‡¯ğŸ‡µ", id: 4 },
        { name: "éŸ©å›½", image: "https://game-random.oss-cn-guangzhou.aliyuncs.com/doc/korea.jpg", flag: "ğŸ‡°ğŸ‡·", id: 5 },
        { name: "é©¬é‡Œ", image: "https://game-random.oss-cn-guangzhou.aliyuncs.com/doc/mali.jpg", flag: "ğŸ‡²ğŸ‡±", id: 6 },
        { name: "è’™å¤å›½", image: "https://game-random.oss-cn-guangzhou.aliyuncs.com/doc/mongolia.jpg", flag: "ğŸ‡²ğŸ‡³", id: 7 },
        { name: "æ³¢å…°", image: "https://game-random.oss-cn-guangzhou.aliyuncs.com/doc/poland.jpg", flag: "ğŸ‡µğŸ‡±", id: 8 },
        { name: "è‘¡è„ç‰™", image: "https://game-random.oss-cn-guangzhou.aliyuncs.com/doc/portugal.jpg", flag: "ğŸ‡µğŸ‡¹", id: 9 },
        { name: "ç½—é©¬", image: "https://game-random.oss-cn-guangzhou.aliyuncs.com/doc/rome.jpg", flag: "ğŸ‡®ğŸ‡¹", id: 10 },
        { name: "ç»´äº¬", image: "https://game-random.oss-cn-guangzhou.aliyuncs.com/doc/vikings.jpg", flag: "ğŸ‡³ğŸ‡´", id: 11 },
        { name: "æ³¢æ–¯", image: "https://game-random.oss-cn-guangzhou.aliyuncs.com/doc/persia.jpg", flag: "ğŸ‡®ğŸ‡·", id: 12 },
        { name: "åŸƒåŠ", image: "https://game-random.oss-cn-guangzhou.aliyuncs.com/doc/egypt.jpg", flag: "ğŸ‡ªğŸ‡¬", id: 13 },
        { name: "å¨å°¼æ–¯", image: "https://game-random.oss-cn-guangzhou.aliyuncs.com/doc/venice.jpg", flag: "ğŸ‡®ğŸ‡¹", id: 14 },
        { name: "é˜¿æ‹‰ä¼¯", image: "https://game-random.oss-cn-guangzhou.aliyuncs.com/doc/arab.jpg", flag: "ğŸ‡¦ğŸ‡ª", id: 15 },
        { name: "å¸Œè…Š", image: "https://game-random.oss-cn-guangzhou.aliyuncs.com/doc/greece.jpg", flag: "ğŸ‡¬ğŸ‡·", id: 16 }
    ];

    // DOMå…ƒç´ 
    const playerBtns = document.querySelectorAll('.player-btn');
    const drawBtn = document.getElementById('drawBtn');
    const redrawBtn = document.getElementById('redrawBtn');
    const resetBtn = document.getElementById('resetBtn');
    const resultSection = document.getElementById('resultSection');
    const initialState = document.getElementById('initialState');
    const loadingState = document.getElementById('loadingState');
    const countryContainer = document.getElementById('countryContainer');
    const resultCount = document.getElementById('resultCount');
    const playerTip = document.getElementById('playerTip');
    const loadingText = document.getElementById('loadingText');
    const loadingBar = document.getElementById('loadingBar');
    const shareBtn = document.getElementById('shareBtn');
    const shareModal = document.getElementById('shareModal');
    const closeShareModal = document.getElementById('closeShareModal');
    const shareUrl = document.getElementById('shareUrl');
    const copyUrlBtn = document.getElementById('copyUrlBtn');
    const shareWechatBtn = document.getElementById('shareWechatBtn');
    const shareQQBtn = document.getElementById('shareQQBtn');

    // çŠ¶æ€å˜é‡
    let selectedPlayerCount = 1;
    let drawnCountries = [];
    let currentSeed = null; // ç”¨äºç”Ÿæˆéšæœºæ•°çš„ç§å­

    // åˆå§‹åŒ–é¡µé¢
    document.addEventListener('DOMContentLoaded', () => {
        // è§£æURLå‚æ•°
        const params = new URLSearchParams(window.location.search);
        const countriesParam = params.get('countries');
        const countParam = params.get('count');
        const seedParam = params.get('seed');

        // å¦‚æœæœ‰æœ‰æ•ˆçš„å‚æ•°ï¼Œç›´æ¥åŠ è½½ç»“æœ
        if (countriesParam && countParam && seedParam) {
            try {
                // è§£æå‚æ•°
                const countryIds = countriesParam.split(',').map(Number);
                const playerCount = parseInt(countParam);

                // éªŒè¯å‚æ•°æœ‰æ•ˆæ€§
                if (countryIds.length === playerCount && playerCount >= 1 && playerCount <= 5) {
                    // æ ¹æ®IDè·å–å›½å®¶æ•°æ®
                    drawnCountries = countryIds.map(id => {
                        const country = countryDatabase.find(c => c.id === id);
                        if (!country) throw new Error('æ— æ•ˆçš„å›½å®¶ID');
                        return country;
                    });

                    // è®¾ç½®é€‰ä¸­çš„ç©å®¶æ•°é‡
                    selectedPlayerCount = playerCount;
                    playerBtns.forEach(btn => {
                        if (parseInt(btn.dataset.count) === selectedPlayerCount) {
                            btn.click(); // è§¦å‘ç‚¹å‡»äº‹ä»¶ä»¥æ›´æ–°UI
                        }
                    });

                    // æ˜¾ç¤ºç»“æœ
                    currentSeed = seedParam;
                    initialState.classList.add('hidden');
                    generateDrawResult(false); // ä¸æ˜¾ç¤ºåŠ è½½çŠ¶æ€ç›´æ¥ç”Ÿæˆç»“æœ
                    return;
                }
            } catch (e) {
                console.error('è§£æURLå‚æ•°å¤±è´¥:', e);
            }
        }

        // é»˜è®¤é€‰ä¸­1äºº
        playerBtns[0].click();

        // æ˜¾ç¤ºåˆå§‹çŠ¶æ€
        initialState.classList.remove('hidden');
    });

    // åˆå§‹åŒ–äººæ•°é€‰æ‹©æŒ‰é’®
    playerBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            // ç§»é™¤å…¶ä»–æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
            playerBtns.forEach(b => {
                b.classList.remove('active', 'bg-primary', 'text-white', 'border-primary');
                b.classList.add('btn-outline');
            });

            // æ·»åŠ å½“å‰æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
            btn.classList.add('active', 'bg-primary', 'text-white', 'border-primary');
            btn.classList.remove('btn-outline');

            // æ›´æ–°é€‰ä¸­çš„äººæ•°
            selectedPlayerCount = parseInt(btn.dataset.count);

            // æ›´æ–°æç¤ºæ–‡æœ¬
            playerTip.textContent = `å·²é€‰æ‹© ${selectedPlayerCount} äººï¼Œå°†éšæœºåˆ†é… ${selectedPlayerCount} ä¸ªä¸åŒå›½å®¶`;
            playerTip.classList.add('text-primary');

            // çŸ­æš‚é«˜äº®æç¤º
            playerTip.classList.add('animate-pulse-slow');
            setTimeout(() => {
                playerTip.classList.remove('animate-pulse-slow');
            }, 1000);
        });
    });

    // æŠ½å–é€»è¾‘
    drawBtn.addEventListener('click', startDraw);
    redrawBtn.addEventListener('click', startDraw);

    // é‡ç½®åŠŸèƒ½
    resetBtn.addEventListener('click', () => {
        // é‡ç½®äººæ•°é€‰æ‹©
        playerBtns.forEach((btn, index) => {
            if (index === 0) {
                btn.classList.add('active', 'bg-primary', 'text-white', 'border-primary');
                btn.classList.remove('btn-outline');
                selectedPlayerCount = 1;
            } else {
                btn.classList.remove('active', 'bg-primary', 'text-white', 'border-primary');
                btn.classList.add('btn-outline');
            }
        });

        // é‡ç½®æç¤º
        playerTip.textContent = "è¯·é€‰æ‹©éœ€è¦åˆ†é…å›½å®¶çš„ç©å®¶äººæ•°";
        playerTip.classList.remove('text-primary');

        // æ˜¾ç¤ºåˆå§‹çŠ¶æ€ï¼Œéšè—ç»“æœ
        resultSection.classList.add('hidden');
        initialState.classList.remove('hidden');
        loadingState.classList.add('hidden');

        // æ¸…ç©ºç»“æœ
        countryContainer.innerHTML = '';
        drawnCountries = [];
        currentSeed = null;

        // æ›´æ–°URLï¼Œç§»é™¤å‚æ•°
        history.pushState({}, document.title, window.location.pathname);
    });

    // åˆ†äº«åŠŸèƒ½
    shareBtn.addEventListener('click', () => {
        if (drawnCountries.length === 0 || !currentSeed) return;

        // ç”Ÿæˆåˆ†äº«URL
        const countryIds = drawnCountries.map(c => c.id).join(',');
        const url = new URL(window.location.href);
        url.searchParams.set('countries', countryIds);
        url.searchParams.set('count', selectedPlayerCount);
        url.searchParams.set('seed', currentSeed);

        // è®¾ç½®åˆ†äº«é“¾æ¥
        shareUrl.value = url.toString();

        // æ˜¾ç¤ºåˆ†äº«æ¨¡æ€æ¡†
        shareModal.classList.remove('hidden');
    });

    // å…³é—­åˆ†äº«æ¨¡æ€æ¡†
    closeShareModal.addEventListener('click', () => {
        shareModal.classList.add('hidden');
    });

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    shareModal.addEventListener('click', (e) => {
        if (e.target === shareModal) {
            shareModal.classList.add('hidden');
        }
    });

    // å¤åˆ¶é“¾æ¥
    copyUrlBtn.addEventListener('click', () => {
        shareUrl.select();
        document.execCommand('copy');

        // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
        const originalText = copyUrlBtn.innerHTML;
        copyUrlBtn.innerHTML = '<i class="fa fa-check mr-1"></i> å·²å¤åˆ¶';
        copyUrlBtn.classList.add('bg-green-50', 'border-green-200', 'text-green-700');

        setTimeout(() => {
            copyUrlBtn.innerHTML = originalText;
            copyUrlBtn.classList.remove('bg-green-50', 'border-green-200', 'text-green-700');
        }, 2000);
    });

    // å¾®ä¿¡åˆ†äº«ï¼ˆæ¨¡æ‹Ÿï¼‰
    shareWechatBtn.addEventListener('click', () => {
        alert('è¯·å°†é“¾æ¥å‘é€ç»™å¾®ä¿¡å¥½å‹ï¼Œæˆ–ä½¿ç”¨å¾®ä¿¡æ‰«æäºŒç»´ç åˆ†äº«');
    });

    // QQåˆ†äº«ï¼ˆæ¨¡æ‹Ÿï¼‰
    shareQQBtn.addEventListener('click', () => {
        alert('è¯·å°†é“¾æ¥å‘é€ç»™QQå¥½å‹');
    });

    // å¼€å§‹æŠ½å–å‡½æ•°
    function startDraw() {
        // éªŒè¯é€‰æ‹©çš„äººæ•°
        if (selectedPlayerCount < 1 || selectedPlayerCount > 5) {
            playerTip.textContent = "è¯·é€‰æ‹©1-5äººçš„æœ‰æ•ˆäººæ•°";
            playerTip.classList.add('text-red-500', 'animate-pulse-slow');
            setTimeout(() => {
                playerTip.classList.remove('animate-pulse-slow');
            }, 1000);
            return;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼Œéšè—å…¶ä»–çŠ¶æ€
        initialState.classList.add('hidden');
        resultSection.classList.add('hidden');
        loadingState.classList.remove('hidden');

        // é‡ç½®åŠ è½½è¿›åº¦
        loadingBar.style.width = '0%';
        loadingText.textContent = `æ­£åœ¨éšæœºé€‰æ‹© ${selectedPlayerCount} ä¸ªå›½å®¶...`;

        // ç”Ÿæˆæ–°çš„éšæœºç§å­
        currentSeed = generateSeed();

        // æ¨¡æ‹ŸåŠ è½½è¿›åº¦
        const progressSteps = 5;
        const stepDuration = 300;
        let currentProgress = 0;

        const progressInterval = setInterval(() => {
            currentProgress += 100 / progressSteps;
            loadingBar.style.width = `${currentProgress}%`;

            // æ›´æ–°åŠ è½½æ–‡æœ¬
            if (currentProgress === 20) loadingText.textContent = "æ­£åœ¨ç­›é€‰å›½å®¶åº“...";
            else if (currentProgress === 40) loadingText.textContent = "æ­£åœ¨éšæœºæ’åº...";
            else if (currentProgress === 60) loadingText.textContent = "æ­£åœ¨é€‰æ‹©åŒ¹é…å›½å®¶...";
            else if (currentProgress === 80) loadingText.textContent = "æ­£åœ¨å‡†å¤‡å±•ç¤ºç»“æœ...";

            if (currentProgress >= 100) {
                clearInterval(progressInterval);

                // å®ŒæˆåŠ è½½åç”Ÿæˆç»“æœ
                setTimeout(() => {
                    generateDrawResult();

                    // æ›´æ–°URLå‚æ•°
                    const countryIds = drawnCountries.map(c => c.id).join(',');
                    const url = new URL(window.location.href);
                    url.searchParams.set('countries', countryIds);
                    url.searchParams.set('count', selectedPlayerCount);
                    url.searchParams.set('seed', currentSeed);
                    history.pushState({}, document.title, url.toString());
                }, 500);
            }
        }, stepDuration);
    }

    // ç”ŸæˆæŠ½å–ç»“æœ
    function generateDrawResult(showLoading = true) {
        if (showLoading) {
            // ä»å›½å®¶åº“ä¸­éšæœºé€‰æ‹©æŒ‡å®šæ•°é‡çš„ä¸åŒå›½å®¶
            drawnCountries = getRandomCountries(selectedPlayerCount);
        }

        // æ›´æ–°ç»“æœè®¡æ•°
        resultCount.textContent = `å…± ${drawnCountries.length} ä¸ªå›½å®¶`;

        // æ¸…ç©ºå®¹å™¨
        countryContainer.innerHTML = '';

        // åˆ›å»ºå›½å®¶å¡ç‰‡
        drawnCountries.forEach((country, index) => {
            // åˆ›å»ºå¡ç‰‡å…ƒç´ 
            const countryCard = document.createElement('div');
            countryCard.className = 'bg-white rounded-xl shadow-md overflow-hidden card-hover animate-slide-up';
            countryCard.style.animationDelay = `${index * 100}ms`;

            // è®¾ç½®å¡ç‰‡å†…å®¹ï¼ŒåŒ…å«å›¾ç‰‡åŠ è½½çŠ¶æ€
            countryCard.innerHTML = `
          <div class="image-container">
            <!-- å›¾ç‰‡åŠ è½½æŒ‡ç¤ºå™¨ -->
            <div class="image-loader" id="loader-${index}">
            <i class="fa fa-circle-o-notch fa-spin text-primary/50"></i>
            </div>
            <img src="${country.image}" alt="${country.name} å°é¢å›¾"
            class="image-cover"
            onload="imageLoaded('loader-${index}', this)"
            onerror="imageError('loader-${index}', this, '${country.name}')">
            <div class="absolute top-3 left-3 bg-primary/80 text-white text-xs font-medium px-2 py-1 rounded">
            ç©å®¶ ${index + 1}
            </div>
            </div>
            <div class="p-4">
            <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold text-lg flex items-center">
            ${country.flag} ${country.name}
            </h3>
            <span class="text-xs text-gray-400">
            #${index + 1}
            </span>
            </div>
            <button class="view-details-btn w-full text-sm text-primary hover:text-primary/80 transition-colors flex items-center justify-center gap-1 py-1">
            <i class="fa fa-search-plus"></i> æŸ¥çœ‹è¯¦æƒ…
            </button>
            </div>
            `;

            // æ·»åŠ åˆ°å®¹å™¨
            countryContainer.appendChild(countryCard);

            // è¯¦æƒ…æŒ‰é’®äº‹ä»¶
            const detailsBtn = countryCard.querySelector('.view-details-btn');
            detailsBtn.addEventListener('click', () => {
                // åˆ›å»ºå¤§å›¾æŸ¥çœ‹æ¨¡æ€æ¡†
                createImageModal(country);
            });
        });

        // æ˜¾ç¤ºç»“æœï¼Œéšè—åŠ è½½çŠ¶æ€
        loadingState.classList.add('hidden');
        resultSection.classList.remove('hidden');
    }

        // å›¾ç‰‡åŠ è½½å®Œæˆå¤„ç†å‡½æ•°ï¼ˆä¼˜åŒ–ï¼šç¡®ä¿åŠ è½½åç«‹å³æ·»åŠ loadedç±»ï¼‰
        function imageLoaded(loaderId, imageElement) {
            const loader = document.getElementById(loaderId);
            if (loader) {
                // å¹³æ»‘éšè—åŠ è½½æŒ‡ç¤ºå™¨
                loader.style.transition = 'opacity 0.3s ease';
                loader.style.opacity = '0';
                setTimeout(() => {
                    loader.style.display = 'none';
                }, 300);
            }
            // ç«‹å³æ ‡è®°å›¾ç‰‡ä¸ºå·²åŠ è½½ï¼Œè§¦å‘æ˜¾ç¤ºåŠ¨ç”»
            imageElement.classList.add('loaded');
        }

        // å›¾ç‰‡åŠ è½½å¤±è´¥å¤„ç†å‡½æ•°ï¼ˆä¼˜åŒ–ï¼šå¤±è´¥æ—¶ä¹Ÿç”¨containæ¨¡å¼ï¼‰
        function imageError(loaderId, imageElement, countryName) {
            const loader = document.getElementById(loaderId);
            if (loader) {
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯æ›¿ä»£åŠ è½½æŒ‡ç¤ºå™¨
                loader.innerHTML = `<i class="fa fa-exclamation-triangle text-amber-500"></i>`;
                loader.classList.add('bg-amber-50');
            }
            // å¤±è´¥å›¾ä¹Ÿç”¨containæ¨¡å¼ï¼Œä¿æŒæ˜¾ç¤ºä¸€è‡´æ€§
            imageElement.src = `https://picsum.photos/seed/${countryName}/600/450`; // 4:3æ¯”ä¾‹çš„å¤‡ç”¨å›¾
            imageElement.alt = `${countryName} å›¾ç‰‡åŠ è½½å¤±è´¥`;
            imageElement.classList.add('loaded'); // å¼ºåˆ¶æ˜¾ç¤ºå¤‡ç”¨å›¾
        }

    // åˆ›å»ºå›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡†ï¼ˆä¼˜åŒ–å¤§å›¾æ˜¾ç¤ºï¼‰
    function createImageModal(country) {
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æ¨¡æ€æ¡†ï¼Œè‹¥æœ‰åˆ™ç§»é™¤
        const existingModal = document.getElementById('imageModal');
        if (existingModal) {
            existingModal.remove();
        }

        // åˆ›å»ºæ¨¡æ€æ¡†å®¹å™¨
        const modal = document.createElement('div');
        modal.id = 'imageModal';
        modal.className = 'fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 animate-fade-in';
        modal.innerHTML = `
            <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] flex flex-col">
                <div class="p-4 border-b flex justify-between items-center">
                    <h3 class="font-semibold text-lg flex items-center">
                        ${country.flag} ${country.name}
                    </h3>
                    <button id="closeModal" class="text-gray-500 hover:text-gray-800">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                <div class="flex-grow flex items-center justify-center p-4 bg-gray-100 relative">
                    <div class="image-loader absolute">
                        <i class="fa fa-circle-o-notch fa-spin text-primary/50"></i>
                    </div>
                    <!-- å¤§å›¾ä¹Ÿç”¨containæ¨¡å¼ï¼Œç¡®ä¿å®Œæ•´æ˜¾ç¤º -->
                    <img src="${country.image}"
                         alt="${country.name} å¤§å›¾"
                         class="max-w-full max-h-[70vh] object-contain rounded opacity-0 transition-opacity duration-300"
                         onload="this.classList.add('opacity-100'); this.previousElementSibling.style.opacity=0; setTimeout(()=>this.previousElementSibling.style.display='none',300)"
                         onerror="this.src='https://picsum.photos/seed/${country.name}/1200/900'; this.classList.add('opacity-100'); this.previousElementSibling.style.opacity=0; setTimeout(()=>this.previousElementSibling.style.display='none',300)">
                </div>
            </div>
        `;

        // æ·»åŠ åˆ°é¡µé¢
        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨

        // å…³é—­æ¨¡æ€æ¡†äº‹ä»¶
        const closeBtn = document.getElementById('closeModal');
        closeBtn.addEventListener('click', () => {
            modal.remove();
            document.body.style.overflow = ''; // æ¢å¤æ»šåŠ¨
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
                document.body.style.overflow = '';
            }
        });
    }

        // ç”Ÿæˆéšæœºç§å­
        function generateSeed() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        // åŸºäºç§å­çš„éšæœºæ•°ç”Ÿæˆå™¨
        function seededRandom(seed) {
            // ç®€å•çš„çº¿æ€§åŒä½™ç”Ÿæˆå™¨
            let s = seed % 2147483647;
            if (s <= 0) s += 2147483646;
            return function() {
                s = s * 16807 % 2147483647;
                return s / 2147483647;
            };
        }

        // ä»å›½å®¶åº“ä¸­è·å–æŒ‡å®šæ•°é‡çš„éšæœºä¸åŒå›½å®¶
        function getRandomCountries(count) {
            // å¤åˆ¶å›½å®¶åº“ä»¥é¿å…ä¿®æ”¹åŸæ•°ç»„
            const countryPool = [...countryDatabase];
            const selectedCountries = [];

            // åˆ›å»ºåŸºäºå½“å‰ç§å­çš„éšæœºæ•°ç”Ÿæˆå™¨
            const random = seededRandom(currentSeed ? currentSeed.hashCode() : Date.now());

            // éšæœºé€‰æ‹©æŒ‡å®šæ•°é‡çš„å›½å®¶
            for (let i = 0; i < count && countryPool.length > 0; i++) {
                // ç”Ÿæˆéšæœºç´¢å¼•
                const randomIndex = Math.floor(random() * countryPool.length);

                // å–å‡ºé€‰ä¸­çš„å›½å®¶å¹¶æ·»åŠ åˆ°ç»“æœä¸­
                selectedCountries.push(countryPool[randomIndex]);

                // ä»æ± ä¸­ç§»é™¤å·²é€‰ä¸­çš„å›½å®¶ï¼ˆé¿å…é‡å¤ï¼‰
                countryPool.splice(randomIndex, 1);
            }

            return selectedCountries;
        }

        // ä¸ºå­—ç¬¦ä¸²æ·»åŠ å“ˆå¸Œç æ–¹æ³•ï¼Œç”¨äºå°†ç§å­è½¬æ¢ä¸ºæ•°å­—
        String.prototype.hashCode = function() {
            let hash = 0;
            for (let i = 0; i < this.length; i++) {
                const char = this.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // è½¬æ¢ä¸º32ä½æ•´æ•°
            }
            return Math.abs(hash);
        };
</script>
</body>
</html>